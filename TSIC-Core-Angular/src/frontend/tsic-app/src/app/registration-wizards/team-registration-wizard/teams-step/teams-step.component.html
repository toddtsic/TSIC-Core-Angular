<!-- Loading state -->
@if (isLoading()) {
<div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading teams...</span>
    </div>
    <p class="mt-3 text-muted">Loading your teams...</p>
</div>
}

<!-- Error message -->
@if (errorMessage()) {
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Error:</strong> {{ errorMessage() }}
    <button type="button" class="btn-close" (click)="errorMessage.set(null)" aria-label="Close"></button>
</div>
}

<!-- Main content -->
@if (!isLoading()) {
<div class="teams-step-container">
    <!-- Header with search and filters -->
    <div class="mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-6">
                <label for="team-search" class="form-label fw-semibold">Search Teams</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="team-search" type="text" class="form-control" placeholder="Search by team name..."
                        [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" />
                </div>
            </div>
            <div class="col-6 col-md-3">
                <label for="filter-grade" class="form-label fw-semibold">Grade Year</label>
                <select id="filter-grade" class="form-select" [ngModel]="filterGradeYear()"
                    (ngModelChange)="filterGradeYear.set($event)">
                    <option value="">All Years</option>
                    @for (year of gradeYears(); track year) {
                    <option [value]="year">{{ year }}</option>
                    }
                </select>
            </div>
            <div class="col-6 col-md-3">
                <label for="filter-level" class="form-label fw-semibold">Level of Play</label>
                <select id="filter-level" class="form-select" [ngModel]="filterLevelOfPlay()"
                    (ngModelChange)="filterLevelOfPlay.set($event)">
                    <option value="">All Levels</option>
                    @for (level of levelsOfPlay(); track level) {
                    <option [value]="level">{{ level }}</option>
                    }
                </select>
            </div>
        </div>
        @if (searchTerm() || filterGradeYear() || filterLevelOfPlay()) {
        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
                <i class="bi bi-x-circle me-1"></i> Clear Filters
            </button>
        </div>
        }
    </div>

    <!-- Financial summary -->
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <div>
            <strong>Total Owed:</strong> {{ totalOwed() | currency }}
            <span class="ms-3 text-muted">{{ registeredTeams().length }} team(s) registered</span>
        </div>
        <button type="button" class="btn btn-sm btn-primary" (click)="openAddTeamModal()">
            <i class="bi bi-plus-circle me-1"></i> Add to Team Library
        </button>
    </div>

    <!-- Dual-table layout (desktop) -->
    <div class="row g-4 d-none d-lg-flex">
        <!-- Available Teams (Left) -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-list-ul me-2"></i>
                        Available Teams
                    </h5>
                    <small class="text-muted">Click to register for this event</small>
                </div>
                <div class="card-body p-0">
                    @if (filteredAvailableTeams().length === 0) {
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        @if (searchTerm() || filterGradeYear() || filterLevelOfPlay()) {
                        <p>No teams match your filters</p>
                        } @else {
                        <p>All teams are registered for this event</p>
                        }
                    </div>
                    } @else {
                    <div class="list-group list-group-flush">
                        @for (team of filteredAvailableTeams(); track team.clubTeamId) {
                        <button type="button"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start py-3"
                            (click)="registerTeam(team)">
                            <div class="flex-grow-1">
                                <div class="fw-semibold">{{ team.clubTeamName }}</div>
                                <div class="small text-muted">
                                    <span class="badge bg-secondary me-2">{{ team.clubTeamGradYear }}</span>
                                    <span class="badge bg-info">{{ team.clubTeamLevelOfPlay }}</span>
                                </div>
                            </div>
                            <i class="bi bi-arrow-right-circle text-primary fs-5"></i>
                        </button>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Registered Teams (Right) -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success bg-opacity-10">
                    <h5 class="mb-0 fw-bold text-success">
                        <i class="bi bi-check-circle me-2"></i>
                        Registered Teams
                    </h5>
                    <small class="text-muted">Click to unregister (if unpaid)</small>
                </div>
                <div class="card-body p-0">
                    @if (filteredRegisteredTeams().length === 0) {
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        @if (searchTerm() || filterGradeYear() || filterLevelOfPlay()) {
                        <p>No registered teams match your filters</p>
                        } @else {
                        <p>No teams registered yet</p>
                        }
                    </div>
                    } @else {
                    <div class="list-group list-group-flush">
                        @for (team of filteredRegisteredTeams(); track team.teamId) {
                        <div class="list-group-item d-flex justify-content-between align-items-start py-3"
                            [class.list-group-item-success]="team.paidTotal === 0"
                            [class.list-group-item-warning]="team.paidTotal > 0">
                            <div class="flex-grow-1">
                                <div class="fw-semibold">{{ team.clubTeamName }}</div>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-secondary me-2">{{ team.clubTeamGradYear }}</span>
                                    <span class="badge bg-info me-2">{{ team.clubTeamLevelOfPlay }}</span>
                                    <span class="badge bg-dark">{{ team.ageGroupName }}</span>
                                </div>
                                <div class="small">
                                    <strong>Fee:</strong> {{ team.feeTotal | currency }} |
                                    <strong>Paid:</strong> {{ team.paidTotal | currency }} |
                                    <strong class="text-danger">Owed:</strong> {{ team.owedTotal | currency }}
                                </div>
                            </div>
                            @if (team.paidTotal === 0) {
                            <button type="button" class="btn btn-sm btn-outline-danger" (click)="unregisterTeam(team)"
                                title="Unregister this team">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            } @else {
                            <span class="badge bg-warning text-dark">Paid</span>
                            }
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Card layout (mobile) -->
    <div class="d-lg-none">
        <!-- Available Teams Cards -->
        <div class="mb-4">
            <h5 class="fw-bold text-primary mb-3">
                <i class="bi bi-list-ul me-2"></i>
                Available Teams
            </h5>
            @if (filteredAvailableTeams().length === 0) {
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    @if (searchTerm() || filterGradeYear() || filterLevelOfPlay()) {
                    <p>No teams match your filters</p>
                    } @else {
                    <p>All teams are registered for this event</p>
                    }
                </div>
            </div>
            } @else {
            @for (team of filteredAvailableTeams(); track team.clubTeamId) {
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="fw-semibold mb-2">{{ team.clubTeamName }}</h6>
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2">{{ team.clubTeamGradYear }}</span>
                        <span class="badge bg-info">{{ team.clubTeamLevelOfPlay }}</span>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm w-100" (click)="registerTeam(team)">
                        <i class="bi bi-arrow-right-circle me-1"></i> Register for Event
                    </button>
                </div>
            </div>
            }
            }
        </div>

        <!-- Registered Teams Cards -->
        <div>
            <h5 class="fw-bold text-success mb-3">
                <i class="bi bi-check-circle me-2"></i>
                Registered Teams
            </h5>
            @if (filteredRegisteredTeams().length === 0) {
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    @if (searchTerm() || filterGradeYear() || filterLevelOfPlay()) {
                    <p>No registered teams match your filters</p>
                    } @else {
                    <p>No teams registered yet</p>
                    }
                </div>
            </div>
            } @else {
            @for (team of filteredRegisteredTeams(); track team.teamId) {
            <div class="card border-0 shadow-sm mb-3" [class.border-success]="team.paidTotal === 0"
                [class.border-warning]="team.paidTotal > 0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-semibold mb-0">{{ team.clubTeamName }}</h6>
                        @if (team.paidTotal > 0) {
                        <span class="badge bg-warning text-dark">Paid</span>
                        }
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-secondary me-2">{{ team.clubTeamGradYear }}</span>
                        <span class="badge bg-info me-2">{{ team.clubTeamLevelOfPlay }}</span>
                        <span class="badge bg-dark">{{ team.ageGroupName }}</span>
                    </div>
                    <div class="small mb-3">
                        <div><strong>Fee:</strong> {{ team.feeTotal | currency }}</div>
                        <div><strong>Paid:</strong> {{ team.paidTotal | currency }}</div>
                        <div class="text-danger"><strong>Owed:</strong> {{ team.owedTotal | currency }}</div>
                    </div>
                    @if (team.paidTotal === 0) {
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" (click)="unregisterTeam(team)">
                        <i class="bi bi-x-circle me-1"></i> Unregister
                    </button>
                    }
                </div>
            </div>
            }
            }
        </div>
    </div>

    <!-- Age Group Availability Section -->
    <div class="mt-5">
        <h5 class="fw-bold mb-3">Age Group Availability</h5>
        <div class="row g-3">
            @for (ag of ageGroups(); track ag.ageGroupId) {
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card border-0 shadow-sm h-100" [class.bg-danger]="ag.registeredCount >= ag.maxTeams"
                    [class.bg-opacity-10]="ag.registeredCount >= ag.maxTeams">
                    <div class="card-body text-center">
                        <h6 class="fw-semibold mb-2">{{ ag.ageGroupName }}</h6>
                        <div class="fs-4 fw-bold" [class.text-danger]="ag.registeredCount >= ag.maxTeams"
                            [class.text-success]="ag.registeredCount < ag.maxTeams">
                            {{ ag.registeredCount }} / {{ ag.maxTeams }}
                        </div>
                        <div class="small text-muted">
                            @if (ag.registeredCount >= ag.maxTeams) {
                            <span class="badge bg-danger">Full</span>
                            } @else {
                            <span class="badge bg-success">{{ ag.maxTeams - ag.registeredCount }} spots left</span>
                            }
                        </div>
                        <div class="mt-2 small">
                            <div>Roster: {{ ag.rosterFee | currency }}</div>
                            <div>Team: {{ ag.teamFee | currency }}</div>
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>
}

<!-- Add New Team Modal -->
@if (showAddTeamModal()) {
<div class="modal d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Team to {{ clubName() }}'s Library</h5>
                <button type="button" class="btn-close" (click)="closeAddTeamModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Add a new team to your club's permanent library. Once created, this team will be available for registration in all future events.</p>
                <form #addTeamForm="ngForm" (ngSubmit)="addNewClubTeam({
                    clubTeamName: teamName.value,
                    clubTeamGradYear: teamGradYear.value,
                    clubTeamLevelOfPlay: teamLevelOfPlay.value
                })">
                    <div class="mb-3">
                        <label for="teamName" class="form-label">Team Name <span class="text-danger">*</span></label>
                        <input id="teamName" #teamName="ngModel" ngModel name="teamName" type="text"
                            class="form-control" placeholder="e.g., U12 Boys Elite" required />
                    </div>
                    <div class="mb-3">
                        <label for="teamGradYear" class="form-label">Graduation Year <span
                                class="text-danger">*</span></label>
                        <input id="teamGradYear" #teamGradYear="ngModel" ngModel name="teamGradYear" type="text"
                            class="form-control" placeholder="e.g., 2013" required pattern="[0-9]{4}" />
                        <div class="form-text">4-digit year (e.g., 2013)</div>
                    </div>
                    <div class="mb-3">
                        <label for="teamAgeGroup" class="form-label">Age Group</label>
                        <select id="teamAgeGroup" #teamAgeGroup="ngModel" ngModel name="teamAgeGroup"
                            class="form-select">
                            <option value="">Select age group (optional)...</option>
                            @for (ag of ageGroups(); track ag.ageGroupId) {
                                <option [value]="ag.ageGroupName">{{ ag.ageGroupName }}</option>
                            }
                        </select>
                        <div class="form-text">Optional: The age group this team typically plays in</div>
                    </div>
                    <div class="mb-3">
                        <label for="teamLevelOfPlay" class="form-label">Level of Play <span
                                class="text-danger">*</span></label>
                        <select id="teamLevelOfPlay" #teamLevelOfPlay="ngModel" ngModel name="teamLevelOfPlay"
                            class="form-select" required>
                            <option value="">Select level...</option>
                            <option value="Elite">Elite</option>
                            <option value="Select">Select</option>
                            <option value="Premier">Premier</option>
                            <option value="Classic">Classic</option>
                            <option value="Recreational">Recreational</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" (click)="closeAddTeamModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" [disabled]="addTeamForm.invalid">
                            <i class="bi bi-plus-circle me-1"></i> Add to Library
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
}
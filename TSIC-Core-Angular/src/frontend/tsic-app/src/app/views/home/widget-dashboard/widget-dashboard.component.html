<div class="dashboard-container" [class.dashboard-public]="isPublic()">

    <!-- ═══════ LOADING / ERROR ═══════ -->
    @if (isLoading()) {
        <div class="dashboard-loading">
            <div class="spinner-border spinner-border-sm text-secondary"></div>
            <span class="text-secondary ms-2">Loading dashboard...</span>
        </div>
    } @else if (hasError()) {
        <div class="dashboard-error">
            <i class="bi bi-exclamation-triangle text-warning"></i>
            <span>Unable to load dashboard</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" (click)="loadDashboard()">Retry</button>
        </div>
    } @else if (isPublic()) {

        <!-- ═══════ PUBLIC MODE: Anonymous landing ═══════ -->
        @if (dashboard(); as db) {
            @for (workspace of db.workspaces; track workspace.workspace) {
                <div class="dashboard-workspace" [class]="'workspace-' + workspace.workspace">
                    @for (category of workspace.categories; track category.categoryId) {
                        <div class="content-widgets">
                            @for (widget of category.widgets; track widget.widgetId) {
                                @if (resolveWidget(widget.componentKey); as cmp) {
                                    <ng-container *ngComponentOutlet="cmp" />
                                }
                            }
                        </div>
                    }
                </div>
            }
        }

    } @else {

        <!-- ═══════ HUB MODE: Dashboard overview ═══════ -->
        @if (dashboard(); as db) {

            <!-- ── Hero: branded strip ── -->
            <div class="dashboard-hero" [class.hero-with-banner]="heroHasBanner()">
                @if (heroHasBanner()) {
                    <div class="hero-bg" [style.background-image]="'url(' + heroBannerBgUrl() + ')'"></div>
                }
                <div class="hero-content">
                    @if (heroLogoUrl()) {
                        <img class="hero-logo" [src]="heroLogoUrl()" alt="" />
                    }
                    <div class="hero-text">
                        <h1 class="hero-job-name">{{ jobName() }}</h1>
                        <div class="hero-meta">
                            <span class="hero-welcome">Welcome back, {{ username() }}</span>
                            @if (roleName()) {
                                <span class="hero-role-badge">{{ roleName() }}</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard workspace content (charts, bulletins) -->
            @for (category of hubCategories(); track category.categoryId) {
                @if (isChartCategory(category)) {
                    <!-- Chart tiles: responsive grid -->
                    <div class="content-widgets chart-tiles">
                        @for (widget of category.widgets; track widget.widgetId) {
                            <div class="chart-tile-wrapper" [class]="'ds-' + getDisplayStyle(widget)">
                                @if (resolveWidget(widget.componentKey); as cmp) {
                                    <ng-container *ngComponentOutlet="cmp" />
                                }
                            </div>
                        }
                    </div>
                } @else if (!isStatusCategory(category)) {
                    <!-- Content widgets (e.g. bulletins for non-admin roles) -->
                    <div class="content-widgets">
                        @for (widget of category.widgets; track widget.widgetId) {
                            @if (resolveWidget(widget.componentKey); as cmp) {
                                <ng-container *ngComponentOutlet="cmp" />
                            }
                        }
                    </div>
                }
            }
        }
    }
</div>

<!-- ═══════ CUSTOMIZE DASHBOARD DIALOG ═══════ -->
@if (showCustomizeDialog()) {
    <tsic-dialog [open]="true" size="sm" (requestClose)="closeCustomize()">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders me-2"></i>Customize Dashboard
                </h5>
                <button type="button" class="btn-close" (click)="closeCustomize()" aria-label="Close"></button>
            </div>
            <div class="modal-body customize-body">
                @if (customizeLoading()) {
                    <div class="customize-loading">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <span class="text-secondary ms-2">Loading widgets...</span>
                    </div>
                } @else {
                    <p class="text-muted customize-hint">Toggle widgets on or off. Use arrows to reorder.</p>
                    <div class="customize-list">
                        @for (row of customizeRows(); track row.widgetId; let i = $index; let first = $first; let last = $last) {
                            <div class="customize-row" [class.customize-row-hidden]="!row.isVisible">
                                <div class="customize-order-controls">
                                    <button class="btn-order" [disabled]="first"
                                            (click)="moveWidget(row, -1)" aria-label="Move up">
                                        <i class="bi bi-chevron-up"></i>
                                    </button>
                                    <button class="btn-order" [disabled]="last"
                                            (click)="moveWidget(row, 1)" aria-label="Move down">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="customize-info">
                                    <div class="customize-name">
                                        <i class="bi" [class]="getWidgetTypeIcon(row.widgetType)"></i>
                                        {{ row.name }}
                                    </div>
                                    @if (row.description) {
                                        <div class="customize-desc">{{ row.description }}</div>
                                    }
                                    <div class="customize-meta">
                                        <span class="badge-type">{{ row.widgetType }}</span>
                                        <span class="badge-category">{{ row.categoryName }}</span>
                                    </div>
                                </div>
                                <label class="customize-toggle" [attr.for]="'widget-toggle-' + row.widgetId">
                                    <input type="checkbox" [id]="'widget-toggle-' + row.widgetId"
                                           [checked]="row.isVisible"
                                           (change)="toggleWidgetVisibility(row)" />
                                    <span class="toggle-track">
                                        <span class="toggle-thumb"></span>
                                    </span>
                                </label>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer customize-footer">
                <button type="button" class="btn btn-outline-danger btn-sm me-auto"
                        (click)="confirmResetCustomizations()" [disabled]="customizeSaving()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="closeCustomize()">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm"
                        (click)="saveCustomizations()" [disabled]="customizeSaving() || customizeLoading()">
                    @if (customizeSaving()) {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Save
                </button>
            </div>
        </div>
    </tsic-dialog>
}

<!-- ═══════ RESET CONFIRM ═══════ -->
@if (showResetConfirm()) {
    <confirm-dialog
        title="Reset Dashboard"
        message="Reset your dashboard to the default layout? Your customizations will be removed."
        confirmLabel="Reset"
        confirmVariant="danger"
        (confirmed)="resetCustomizations()"
        (cancelled)="showResetConfirm.set(false)">
    </confirm-dialog>
}

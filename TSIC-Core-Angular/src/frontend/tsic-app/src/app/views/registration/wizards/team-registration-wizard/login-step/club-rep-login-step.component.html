<div class="accordion mt-2 mb-4" id="wizardAccordion">
    <div class="accordion-item accordion-item-info border-2">
        <h2 class="accordion-header">
            <button class="accordion-button accordion-button-info" type="button"
                [class.collapsed]="credentialsCollapsed()" (click)="toggleCredentialsCollapsed()"
                [attr.aria-expanded]="!credentialsCollapsed()" aria-controls="credentialsCollapse">
                <i class="bi bi-info-circle accordion-icon-info text-primary me-2"></i>
                <span class="accordion-title-info">Club Rep Credentials</span>
            </button>
        </h2>
        <div id="credentialsCollapse" class="accordion-collapse collapse" [class.show]="!credentialsCollapsed()">
            <div class="accordion-body">
                <ul class="mb-0 small ps-3">
                    <li>Use Club Rep credentials only. Do not use coach or director login.</li>
                    <li>Only one rep should register teams to avoid duplicates and removal from
                        this event.</li>
                    <li>Never share this account - it has visibility over club and player
                        information.</li>
                    <li>If you have a Player or Coach account, you must create a separate
                        username for Club Rep registration.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-3 pt-1">
    <h5 class="mb-0 fw-semibold">Have <strong class="text-primary">CLUB REP</strong> credentials?</h5>

    <div class="btn-group" role="radiogroup" aria-label="Club Rep account availability">
        <input type="radio" class="btn-check" name="hasClubRepAccountMobile" id="seg-hasClubRep-yes" [value]="'yes'"
            [checked]="hasClubRepAccount() === 'yes'" (change)="onHasCredentialsChange('yes')" />
        <label class="btn btn-outline-primary px-4" for="seg-hasClubRep-yes"
            (click)="onHasCredentialsChange('yes')">Yes</label>

        <input type="radio" class="btn-check" name="hasClubRepAccountMobile" id="seg-hasClubRep-no" [value]="'no'"
            [checked]="hasClubRepAccount() === 'no'" (change)="hasClubRepAccount.set('no')" />
        <label class="btn btn-outline-primary px-4" for="seg-hasClubRep-no"
            (click)="hasClubRepAccount.set('no')">No</label>
    </div>
</div>

<fieldset aria-labelledby="clubRepLegend" class="mt-2">
    <legend id="clubRepLegend" class="visually-hidden">Club Rep account availability</legend>
    <div class="list-group list-group-flush">

        @if (hasClubRepAccount() === 'no') {
        <div class="pt-2 pb-3 ps-0">
            <div class="alert alert-info mb-3" role="alert">
                <h6 class="alert-heading fw-bold mb-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>IMPORTANT: Club-Specific Registration
                </h6>
                <ul class="mb-0 small ps-3">
                    <li class="fw-bold">Club Reps are specific to ONE individual club, not parent organizations or club
                        networks.</li>
                    <li class="fw-bold">If your club has a parent organization that owns multiple clubs (e.g., "Acme
                        NJ", "Acme CA"), each club
                        MUST have its own dedicated Club Rep with an address in that club's state.</li>
                    <li>A single club rep <strong>CAN</strong> represent multiple clubs using a <strong>single</strong>
                        login.</li>
                </ul>
            </div>
            <div class="border-2 rounded p-3 bg-body shadow-sm">
                @if (registrationError()) {
                <div class="alert alert-danger py-2 mb-3" role="alert">
                    {{ registrationError() }}
                </div>
                }
                @if (duplicateClub().length > 0) {
                <div class="alert alert-warning py-2 mb-3" role="alert">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Warning:</strong> Similar clubs already exist:
                            <ul class="mb-0 mt-1">
                                @for (club of duplicateClub(); track club.clubId) {
                                <li>{{ club.clubName }} ({{ club.state }}) - {{
                                    club.matchScore }}% match</li>
                                }
                            </ul>
                            <small class="d-block mt-2">Please verify this is not a
                                duplicate. You may proceed if this is a different
                                club.</small>
                        </div>
                        <button type="button" class="btn-close btn-sm" aria-label="Dismiss"
                            (click)="dismissDuplicateWarning()"></button>
                    </div>
                </div>
                }
                <form class="club-rep-registration-form" [formGroup]="registrationForm"
                    (ngSubmit)="submitRegistration()">
                    <div class="row g-2 mb-2">
                        <div class="col-12 col-md-6">
                            <label for="reg-username" class="form-label font-medium d-flex align-items-center">
                                Username
                                <span class="text-danger">*</span>
                                <app-info-tooltip
                                    message="Your Club Rep username must be different from any Player or Coach account username. We recommend: yourname_clubrep. This account should NEVER be shared. If you need to register a Player or yourself as a Coach, you must create a separate FAMILY or STAFF account." />
                            </label>
                            <input id="reg-username" formControlName="username" class="form-control"
                                placeholder="Enter username (e.g., jsmith_clubrep)" autocomplete="username" required aria-required="true" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="reg-password" class="form-label font-medium d-flex align-items-center">
                                Password
                                <span class="text-danger">*</span>
                                <app-info-tooltip
                                    message="Keep this password secure and do NOT share it. Club Rep accounts access private information about multiple teams and many families' children." />
                            </label>
                            <input id="reg-password" formControlName="password" class="form-control" type="password"
                                placeholder="Create password" autocomplete="new-password" required aria-required="true"
                                aria-describedby="reg-password-hint" [attr.aria-invalid]="registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched" />
                            <div id="reg-password-hint" class="form-text small text-muted">Minimum 6 characters
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mb-2 mt-1">
                        <div class="col-12">
                            <label for="reg-clubName" class="form-label font-medium">Club Name
                                <span class="text-danger">*</span></label>
                            <input id="reg-clubName" formControlName="clubName" class="form-control"
                                placeholder="Enter club name" required aria-required="true" />
                        </div>
                    </div>
                    <fieldset class="mt-3">
                        <legend class="small fw-bold text-primary">Club Rep Contact Details</legend>
                        <div class="row g-2 mb-3 mt-2">
                            <div class="col-12 col-md-6">
                                <label for="reg-firstname" class="form-label font-medium">First Name
                                    <span class="text-danger">*</span></label>
                                <input id="reg-firstname" formControlName="firstName" class="form-control"
                                    placeholder="Enter first name" required aria-required="true" />
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="reg-lastname" class="form-label font-medium">Last Name
                                    <span class="text-danger">*</span></label>
                                <input id="reg-lastname" formControlName="lastName" class="form-control"
                                    placeholder="Enter last name" required aria-required="true" />
                            </div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-12 col-md-6">
                                <label for="reg-email" class="form-label font-medium">Email
                                    <span class="text-danger">*</span></label>
                                <input id="reg-email" formControlName="email" class="form-control" type="email"
                                    placeholder="Enter email" autocomplete="email" required aria-required="true" />
                            </div>
                            <div class="col-12 col-md-6">
                                <label for="reg-cellphone" class="form-label font-medium">Cell Phone
                                    <span class="text-danger">*</span></label>
                                <input id="reg-cellphone" formControlName="cellphone" class="form-control" type="tel"
                                    placeholder="Enter cell phone" autocomplete="tel" required aria-required="true"
                                    aria-describedby="reg-cellphone-hint" [attr.aria-invalid]="registrationForm.get('cellphone')?.invalid && registrationForm.get('cellphone')?.touched" />
                                <div id="reg-cellphone-hint" class="form-text small text-muted">Numbers only</div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="mt-1">
                        <div class="row g-2 mb-2 mt-1">
                            <div class="col-12">
                                <label for="reg-street" class="form-label font-medium">Street
                                    Address
                                    <span class="text-danger">*</span></label>
                                <input id="reg-street" formControlName="street" class="form-control"
                                    placeholder="Enter street address" autocomplete="address-line1" required aria-required="true" />
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-12 col-md-5">
                                <label for="reg-city" class="form-label font-medium">City
                                    <span class="text-danger">*</span></label>
                                <input id="reg-city" formControlName="city" class="form-control"
                                    placeholder="Enter city" autocomplete="address-level2" required aria-required="true" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label for="reg-state" class="form-label font-medium d-flex align-items-center">
                                    State
                                    <span class="text-danger">*</span>
                                    <app-info-tooltip
                                        message="CRITICAL: Must be the state where your CLUB operates, NOT your corporate headquarters or parent organization. Multi-state organizations must create separate Club Rep accounts for each state/regional club." />
                                </label>
                                <select id="reg-state" formControlName="state" class="form-select"
                                    autocomplete="address-level1" required aria-required="true">
                                    <option value="" disabled>Select club's state</option>
                                    @for (s of statesOptions; track s.value) {
                                    <option [value]="s.value">{{ s.label }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <label for="reg-zip" class="form-label font-medium">ZIP Code
                                    <span class="text-danger">*</span></label>
                                <input id="reg-zip" formControlName="zip" class="form-control" placeholder="ZIP"
                                    autocomplete="postal-code" required aria-required="true" />
                            </div>
                        </div>
                    </fieldset>
                    <button type="submit" class="btn btn-primary btn-sm d-block mx-auto"
                        [disabled]="registrationForm.invalid || registrationSubmitting()">
                        @if (registrationSubmitting()) { <span class="spinner-border spinner-border-sm me-2"
                            role="status" aria-hidden="true"></span> }
                        <span>{{ registrationSubmitting() ? 'Creating Account…' : 'Create Club Rep Account'
                            }}</span>
                    </button>
                </form>
            </div>
        </div>
        }
    </div>
</fieldset>

@if (duplicateModalOpen()) {
<app-wizard-modal
    title="Possible Duplicate Club"
    titleIcon="bi-exclamation-triangle text-warning"
    (closed)="closeDuplicateModal()">
    <div modal-body>
        <div class="alert alert-warning" role="alert">
            @if (duplicateModalMessage()) {
            <p class="mb-3 fw-bold">{{ duplicateModalMessage() }}</p>
            }

            @if (duplicateClub().length > 0) {
            <div class="mb-3">
                <h6 class="fw-semibold mb-2">Similar clubs found:</h6>
                <ul class="mb-0 ps-3">
                    @for (club of duplicateClub(); track club.clubId) {
                    <li>{{ club.clubName }} ({{ club.state }}) - {{ club.matchScore }}% match</li>
                    }
                </ul>
            </div>
            }

            <ul class="small text-muted mb-0 ps-3">
                <li>If this is your club, please log in with the existing Club Rep account or contact support
                    (<a href="mailto:support@teamsportsinfo.com">support&#64;teamsportsinfo.com</a>) to recover
                    access.</li>
                <li>Creating duplicate club reps for the same club can cause big problems for tournaments,
                    especially if multiple reps register the same teams.</li>
                <li class="fw-bold text-body-emphasis">DO NOT create a new club name with slightly different name to
                    circumvent this warning. Your teams may be dropped.</li>
            </ul>
        </div>
    </div>
    <div modal-footer class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" (click)="closeDuplicateModal()">Close</button>
    </div>
</app-wizard-modal>
}

<!-- Club Rep Login Modal (credentials + club selection in one) -->
@if (showLoginModal()) {
<app-wizard-modal
    [title]="loginModalStep() === 'credentials' ? 'Club Rep Login' : 'Select Your Club'"
    [titleIcon]="loginModalStep() === 'credentials' ? 'bi-box-arrow-in-right' : 'bi-check-circle'"
    [headerClass]="'text-white border-0 py-2 py-md-3 ' + (loginModalStep() === 'credentials' ? 'bg-primary' : 'bg-success')"
    (closed)="closeLoginModal()">
    <div modal-body>
        <!-- Step Indicator -->
        <div class="d-flex justify-content-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <span class="badge" [class.bg-primary]="loginModalStep() === 'credentials'"
                    [class.bg-secondary]="loginModalStep() !== 'credentials'">
                    1
                </span>
                <span class="text-muted small">Credentials</span>
                <i class="bi bi-arrow-right text-muted"></i>
                <span class="badge" [class.bg-primary]="loginModalStep() === 'clubSelection'"
                    [class.bg-secondary]="loginModalStep() !== 'clubSelection'">
                    2
                </span>
                <span class="text-muted small">Select Club</span>
            </div>
        </div>

        <!-- Step 1: Credentials Entry -->
        @if (loginModalStep() === 'credentials') {
        <form [formGroup]="loginForm" (ngSubmit)="signInThenProceed()">
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <label for="modalUsername" class="form-label fw-semibold">Username</label>
                    <input id="modalUsername" class="form-control" type="text" name="username"
                        formControlName="username" autocomplete="username" placeholder="Enter your username"
                        appAutofocus />
                </div>
                <div class="col-12">
                    <label for="modalPassword" class="form-label fw-semibold">Password</label>
                    <input id="modalPassword" class="form-control" type="password" name="password"
                        formControlName="password" autocomplete="current-password"
                        placeholder="Enter your password" />
                </div>
            </div>

            @if (inlineError()) {
            <div class="alert alert-danger py-2 mb-3" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>{{ inlineError() }}
            </div>
            }

            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-secondary" (click)="closeLoginModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary"
                    [disabled]="loginSubmitting() || loginForm.invalid">
                    @if (loginSubmitting()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-box-arrow-in-right me-1"></i>
                    {{ loginSubmitting() ? 'Signing in…' : 'Continue' }}
                </button>
            </div>
        </form>
        }

        <!-- Step 2: Club Selection -->
        @if (loginModalStep() === 'clubSelection') {
        <div>
            @if (clubSelectionError()) {
            <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>{{ clubSelectionError() }}
                <button type="button" class="btn-close" (click)="clubSelectionError.set(null)"></button>
            </div>
            }

            <div class="mb-3">
                <label for="modalClubSelector" class="form-label fw-semibold">
                    @if (availableClubs().length === 1) {
                    Confirm your club
                    } @else {
                    Which of your clubs do you want to represent today?
                    }
                </label>
                <select id="modalClubSelector" class="form-select" [ngModel]="selectedClub()"
                    (ngModelChange)="selectClubInModal($event)"
                    [size]="availableClubs().length > 3 ? 3 : availableClubs().length">
                    @for (club of availableClubs(); track club.clubName) {
                    <option [value]="club.clubName">
                        {{ club.clubName }}
                    </option>
                    }
                </select>
                @if (availableClubs().length > 1) {
                <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Select the club you'll be registering teams for in this tournament.
                </div>
                }
            </div>

            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-secondary" (click)="closeLoginModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" (click)="continueFromClubSelection()"
                    [disabled]="!selectedClub()">
                    <i class="bi bi-check-circle me-1"></i>
                    Continue
                </button>
            </div>
        </div>
        }
    </div>
</app-wizard-modal>
}

<!-- CONFLICT WARNING MODAL -->
@if (conflictWarningOpen()) {
<app-wizard-modal
    title="Another Rep Has Already Registered Teams"
    titleIcon="bi-exclamation-octagon text-danger"
    headerClass="bg-danger-subtle"
    (closed)="cancelDueToConflict()">
    <div modal-body>
        <div class="alert alert-danger mb-3" role="alert">
            <h6 class="fw-bold mb-2">Registration Conflict Detected</h6>
            <p class="mb-2">
                <strong>{{ conflictWarningUsername() }}</strong> has already registered
                <strong>{{ conflictWarningTeamCount() }}</strong>
                {{ conflictWarningTeamCount() === 1 ? 'team' : 'teams' }}
                for this event under your club.
            </p>
            <p class="mb-0 fw-semibold text-danger">
                Only ONE club rep can register teams per event to avoid duplicates and potential
                disqualification.
            </p>
        </div>

        <div class="bg-body-secondary border border-warning rounded p-3 mb-3">
            <h6 class="fw-semibold mb-2">
                <i class="bi bi-info-circle text-primary me-1"></i>
                What This Means:
            </h6>
            <ul class="mb-0 small ps-3">
                <li>If you proceed, you will be <strong>BLOCKED</strong> from registering teams because another
                    rep has already claimed this event.</li>
                <li>Attempting to register will result in an error message.</li>
                <li>You should coordinate with {{ conflictWarningUsername() }} to determine who will handle team
                    registration.</li>
                <li>Only ONE person should register teams for your club in each event.</li>
            </ul>
        </div>

        <p class="text-muted small mb-0">
            <i class="bi bi-lightbulb text-warning me-1"></i>
            <strong>Recommendation:</strong> Contact your organization administrator or {{
            conflictWarningUsername() }}
            before proceeding. If you need to take over registration, {{ conflictWarningUsername() }} must
            contact
            support to transfer their teams first.
        </p>
    </div>
    <div modal-footer class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDueToConflict()">
            <i class="bi bi-x-circle me-1"></i>
            Cancel Login
        </button>
        <button type="button" class="btn btn-warning" (click)="proceedDespiteConflict()">
            <i class="bi bi-exclamation-triangle me-1"></i>
            I Understand, Proceed Anyway
        </button>
    </div>
</app-wizard-modal>
}
<main class="container-fluid px-3 py-2" aria-labelledby="tw-title">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- Fixed header region containing title, step indicator, and action bar -->
      <div class="wizard-fixed-header">
        <div class="text-center mb-3">
          @if (clubName()) {
          <!-- Mobile: single compact line -->
          <h2 id="tw-title" class="d-block d-md-none mb-0 fw-bold fs-6">
            <span class="text-primary">{{ clubName() }}</span> â€¢ Team Registration
          </h2>
          <!-- Desktop: two lines -->
          <div id="tw-title-desktop" class="d-none d-md-block mb-1">
            <div class="fw-bold fs-4 text-primary">{{ clubName() }}</div>
            <h2 class="mb-0 fw-bold">Team Registration</h2>
          </div>
          } @else {
          <h2 class="mb-1 fw-bold fs-5 fs-md-3">
            Team Registration
          </h2>
          }
        </div>

        @if (!isLoadingMetadata() && !metadataError()) {
        <div class="mb-4">
          <app-step-indicator [steps]="stepDefinitions()" [currentIndex]="currentStepIndex()" />
        </div>
        }

        <!-- Action bar (fixed at top) -->
        @if (step() !== WizardStep.Login) {
        <div class="mb-0">
          <div class="wizard-action-bar-container">
            <app-tw-action-bar [canBack]="step() !== WizardStep.Login" [canContinue]="actionBarCanContinue()"
              [continueLabel]="actionBarContinueLabel()" [showContinue]="actionBarShowContinue()"
              [detailsBadgeLabel]="actionBarDetailsBadge()" [detailsBadgeClass]="actionBarDetailsBadgeClass()"
              (back)="prevStep()" (continue)="nextStep()" />
          </div>
        </div>
        }
      </div>

      <!-- Scrollable content region -->
      <div class="wizard-scrollable-content">
        <div class="card shadow-lg border-0 card-rounded wizard-theme-team mt-3">
          <!-- Registration Status Banner -->
          @if (isLoadingMetadata()) {
          <!-- Loading state -->
          <div class="alert alert-secondary mb-0 rounded-0 rounded-top d-flex align-items-center" role="alert">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <div class="flex-grow-1">
              <strong>Loading...</strong> Checking registration status.
            </div>
          </div>
          } @else if (step() !== WizardStep.RegisterTeams) {
          <!-- Step-specific banner with contextual messaging (suppressed for RegisterTeams step) -->
          <div class="alert {{
              stepBannerConfig().alertClass
            }} mb-0 rounded-0 rounded-top d-flex align-items-center" role="alert">
            <i class="bi {{ stepBannerConfig().icon }} me-2 fs-5"></i>
            <div class="flex-grow-1">
              @if (stepBannerConfig().title) {
              <strong>{{ stepBannerConfig().title }}</strong>{{ " " }}
              }
              <span [innerHTML]="stepBannerConfig().message"></span>
            </div>
          </div>
          }

          <div class="card-body bg-surface px-4 pb-4 pt-2">
            @if (metadataError()) {
            <!-- Error state - show retry -->
            <div class="alert alert-danger d-flex align-items-start" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
              <div class="flex-grow-1">
                <strong>Error:</strong> {{ metadataError() }}
              </div>
            </div>
            <div class="text-center py-4">
              <button type="button" class="btn btn-primary" (click)="loadMetadata(jobPath() || '')"
                [disabled]="!jobPath()">
                <i class="bi bi-arrow-clockwise me-1"></i> Retry
              </button>
            </div>
            } @else if (isLoadingMetadata()) {
            <!-- Loading state - block interaction -->
            <div class="text-center py-5">
              <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-muted">Preparing registration wizard...</p>
            </div>
            } @else if (step() === WizardStep.Login) {
            <app-club-rep-login-step [jobPath]="jobPath()" (loginSuccess)="handleLoginSuccess($event)"
              (registrationSuccess)="handleRegistrationSuccess($event)"></app-club-rep-login-step>
            }

            @if (step() === WizardStep.RegisterTeams) {
            <app-teams-step (proceed)="step.set(WizardStep.Payment)"></app-teams-step>
            }

            @if (step() === WizardStep.Payment) {
            <app-team-payment-step (proceed)="step.set(WizardStep.Review)"></app-team-payment-step>
            }

            @if (step() === WizardStep.Review) {
            <app-review-step [registrationId]="registrationId()"></app-review-step>
            }
          </div>
          <!-- /card-body -->
        </div>
        <!-- /card -->
      </div>
      <!-- /wizard-scrollable-content -->

    </div>
    <!-- /col -->
  </div>
  <!-- /row -->
</main>

<!-- Club Selection Modal -->
@if (showClubSelectionModal()) {
<div class="modal d-block" tabindex="-1" role="dialog"
  style="background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px)">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border shadow-lg" style="
          background-color: var(--bs-card-bg);
          border-color: var(--bs-border-color) !important;
          border-width: 2px !important;
        ">
      <div class="modal-header bg-primary text-white border-0 py-2 py-md-3">
        <div class="d-flex align-items-start w-100">
          <i class="bi bi-building me-2 mt-1 flex-shrink-0 fs-6 fs-md-5"></i>
          <h4 class="modal-title mb-0 flex-grow-1 fs-6 fs-md-5">
            @if (availableClubs().length === 1) {
            Confirm Your Club
            } @else {
            Select Your Club
            }
          </h4>
          <button type="button" class="btn-close btn-close-white" (click)="cancelClubSelection()"
            aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body p-3 p-md-4">
        @if (inlineError()) {
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ inlineError() }}
          <button type="button" class="btn-close" (click)="inlineError.set(null)"></button>
        </div>
        }

        <!-- Info Accordion -->
        <div class="accordion mb-3" id="clubInfoAccordion">
          <div class="accordion-item accordion-item-info border-2">
            <h2 class="accordion-header">
              <button class="accordion-button accordion-button-info" type="button"
                [class.collapsed]="clubInfoCollapsed()" (click)="toggleClubInfoCollapsed()"
                [attr.aria-expanded]="!clubInfoCollapsed()" aria-controls="clubInfoCollapse">
                <i class="bi bi-info-circle accordion-icon-info me-2"></i>
                <span class="accordion-title-info">Important Club Rep Information</span>
              </button>
            </h2>
            <div id="clubInfoCollapse" class="accordion-collapse collapse" [class.show]="!clubInfoCollapsed()">
              <div class="accordion-body">
                <ul class="mb-2 small ps-3">
                  <li>
                    <strong>Multiple Clubs:</strong> A club rep
                    <strong>CAN</strong> represent multiple clubs (e.g.,
                    ACME-NJ, ACME-CA).
                  </li>
                  <li>
                    <strong>One Rep Per Tournament:</strong> While a single
                    club <strong>CAN</strong> have multiple club reps,
                    <strong class="text-danger">ONLY ONE REP CAN REGISTER TEAMS FOR AN INDIVIDUAL
                      TOURNAMENT</strong>
                    to avoid duplicate registrations.
                  </li>
                  <li>
                    <strong>Coordination:</strong> If your club has multiple
                    reps, coordinate before registering to ensure only one
                    person registers for each event.
                  </li>
                  <li class="fw-bold text-danger">
                    DO NOT create a new club name with slightly different name
                    to circumvent this warning. Your teams may be dropped.
                  </li>
                </ul>
                @if (!clubRepInfoAlreadyRead()) {
                <div class="text-end mt-1">
                  <button type="button" class="btn btn-outline-primary btn-sm" (click)="acknowledgeClubRepInfo()">
                    <i class="bi bi-check-circle me-1"></i>Got it!
                  </button>
                </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Always show dropdown, preselect if only 1 club -->
        <div class="mb-3">
          <label for="clubSelector" class="form-label fw-semibold small mb-1">
            @if (availableClubs().length === 1) {
            Your Club
            } @else {
            Select Your Club
            }
          </label>
          <select id="clubSelector" class="form-select" [ngModel]="selectedClub()" size="2"
            (ngModelChange)="selectedClub.set($event); selectClub($event)">
            >
            @for (club of availableClubs(); track club.clubName) {
            <option [value]="club.clubName">{{ club.clubName }}</option>
            }
          </select>
        </div>
        @if (availableClubs().length === 0) {
        <!-- Zero Clubs: Show message -->
        <div class="alert alert-warning mb-3" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>No clubs available.</strong> Use "Manage Clubs" below to
          add a club.
        </div>
        }

        <!-- Add Club Form (revealed inline when showAddClubModal = true) -->
        @if (showAddClubModal()) {
        <hr class="my-3" />
        <h6 class="fw-bold mb-3">
          <i class="bi bi-plus-circle me-2"></i>Add Another Club
        </h6>

        @if (addClubError()) {
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
          <i class="bi bi-exclamation-circle me-2"></i>{{ addClubError() }}
          <button type="button" class="btn-close" (click)="addClubError.set(null)"></button>
        </div>
        }
        @if (addClubSuccess()) {
        <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
          <i class="bi bi-check-circle me-2"></i>{{ addClubSuccess() }}
          <button type="button" class="btn-close" (click)="addClubSuccess.set(null)"></button>
        </div>
        }

        <form [formGroup]="addClubForm">
          <div class="mb-3">
            <label for="addClubName" class="form-label fw-semibold">Club Name</label>
            <input type="text" id="addClubName" class="form-control" formControlName="clubName"
              placeholder="Enter club name" />
          </div>

          @if (similarClubs().length > 0) {
          <div class="alert alert-warning" role="alert">
            <div class="d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-2 mt-1 flex-shrink-0"></i>
              <div>
                <strong>Similar clubs found:</strong>
                <ul class="mb-2 mt-1 ps-3">
                  @for (club of similarClubs(); track club.clubId) {
                  <li>
                    {{ club.clubName }} ({{ club.state }}) -
                    {{ club.matchScore }}% match
                  </li>
                  }
                </ul>
                <p class="mb-0 small">Is one of these your club?</p>
              </div>
            </div>
          </div>
          }

          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelAddClub()">
              <i class="bi bi-x me-1"></i> Cancel
            </button>
            <button type="button" class="btn btn-primary btn-sm" [disabled]="addClubForm.invalid || addClubSubmitting()"
              (click)="submitAddClub()">
              @if (addClubSubmitting()) {
              <span class="spinner-border spinner-border-sm me-1"></span>
              }
              <i class="bi bi-plus-circle me-1"></i> Add Club
            </button>
          </div>
        </form>
        }

        <!-- Bottom Actions -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div></div>
          @if (!showAddClubModal()) {
          <div class="d-flex gap-2">
            @if (availableClubs().length === 1) {
            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelClubSelection()">
              <i class="bi bi-x-circle me-1"></i> Cancel
            </button>
            <button type="button" class="btn btn-primary btn-sm" (click)="continueFromStep1()" autofocus>
              <i class="bi bi-check-circle me-1"></i> Confirm
            </button>
            } @else {
            <button type="button" class="btn btn-primary btn-sm" [disabled]="!selectedClub()"
              (click)="continueFromStep1()">
              <i class="bi bi-arrow-right-circle me-1"></i> Continue
            </button>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
}
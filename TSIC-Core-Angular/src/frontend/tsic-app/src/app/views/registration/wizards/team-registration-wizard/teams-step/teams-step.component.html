<!-- Loading state -->
@if (isLoading()) {
<div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading teams...</span>
    </div>
    <p class="mt-3 text-muted">Loading registration data...</p>
</div>
} @else {

<!-- Error message -->
@if (errorMessage()) {
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Error:</strong> {{ errorMessage() }}
    <button type="button" class="btn-close" (click)="errorMessage.set(null)" aria-label="Close"></button>
</div>
}

<!-- Main content -->
<div class="teams-step-container">
    <!-- Add Team Button -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Registered Teams</h4>
        <button type="button" class="btn btn-primary" (click)="openRegistrationModal()">
            <i class="bi bi-plus-circle-fill me-2 d-none d-sm-inline"></i><span class="d-sm-none">Add </span><span
                class="d-none d-sm-inline">Add New </span>Team
        </button>
    </div>

    <!-- Registered Teams List -->
    <div class="card border-0 shadow-sm">
        @if (registeredTeams().length === 0) {
        <div class="p-5 text-center text-muted">
            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
            <p class="mb-2 fw-semibold">No teams registered yet</p>
            <p class="small mb-0">Click "Add New Team" to register your first team for this event.</p>
        </div>
        } @else {
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-uppercase fw-bold small" style="width: 40px;">#</th>
                        <th class="text-uppercase fw-bold small">Team</th>
                        <th class="text-uppercase fw-bold small"><span class="d-md-none">Age</span><span
                                class="d-none d-md-inline">Age Group</span></th>
                        <th class="text-uppercase fw-bold small lop-col"><span class="d-md-none">LOP</span><span
                                class="d-none d-md-inline">Level</span></th>
                        <th class="text-uppercase fw-bold small text-end d-none d-md-table-cell" style="width: 100px;">Reg Date</th>
                        <th class="text-uppercase fw-bold small text-end" style="width: 95px;">Fee</th>
                        <th class="text-uppercase fw-bold small text-end d-none d-md-table-cell" style="width: 95px;">Paid</th>
                        <th class="text-uppercase fw-bold small text-end d-none d-md-table-cell" style="width: 95px;">Deposit Due</th>
                        <th class="text-uppercase fw-bold small text-end d-none d-md-table-cell" style="width: 110px;">Additional Due</th>
                        <th class="text-end d-md-none"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (team of registeredTeams(); track team.teamId; let idx = $index) {
                    <tr>
                        <td class="text-muted">{{ idx + 1 }}</td>
                        <td class="fw-semibold">{{ team.teamName }}</td>
                        <td>{{ team.ageGroupName }}</td>
                        <td class="text-muted lop-col">{{ team.levelOfPlay || 'N/A' }}</td>
                        <td class="text-end text-muted d-none d-md-table-cell">{{ team.registrationTs | date:'M/d/yy' }}</td>
                        <td class="text-end text-warning">{{ team.feeTotal | currency }}</td>
                        <td class="text-end text-success d-none d-md-table-cell">{{ team.paidTotal | currency }}</td>
                        <td class="text-end d-none d-md-table-cell" [class.text-warning]="team.depositDue > 0" [class.text-muted]="team.depositDue === 0">
                            {{ team.depositDue | currency }}
                        </td>
                        <td class="text-end d-none d-md-table-cell" [class.text-warning]="team.additionalDue > 0" [class.text-muted]="team.additionalDue === 0">
                            {{ team.additionalDue | currency }}
                        </td>
                        <td class="text-end d-md-none">
                            @if (team.paidTotal === 0) {
                            <button type="button" class="btn btn-sm btn-outline-danger" (click)="unregisterTeam(team)"
                                title="Remove from event">
                                <i class="bi bi-x-circle me-1"></i>Remove
                            </button>
                            } @else {
                            <span class="badge bg-success">Paid</span>
                            }
                        </td>
                    </tr>
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr class="fw-bold d-none d-md-table-row">
                        <td colspan="1" class="text-muted">{{ registeredTeams().length }}</td>
                        <td colspan="3"></td>
                        <td></td>
                        <td class="text-end text-warning">{{ financialSummary().feesTotal | currency }}</td>
                        <td class="text-end text-success">{{ financialSummary().paidTotal | currency }}</td>
                        <td class="text-end" [class.text-warning]="financialSummary().depositDueTotal > 0" [class.text-muted]="financialSummary().depositDueTotal === 0">
                            {{ financialSummary().depositDueTotal | currency }}
                        </td>
                        <td class="text-end" [class.text-warning]="financialSummary().additionalDueTotal > 0" [class.text-muted]="financialSummary().additionalDueTotal === 0">
                            {{ financialSummary().additionalDueTotal | currency }}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Stats footer (mobile only) -->
        <div class="card-footer bg-light border-top d-md-none">
            <div class="row g-2">
                <div class="col-6 col-md-auto">
                    <span class="badge bg-primary-subtle text-primary">
                        <i class="bi bi-people-fill me-1"></i>Teams: {{ registeredTeams().length }}
                    </span>
                </div>
                <div class="col-6 col-md-auto">
                    <span class="badge bg-danger-subtle text-danger">
                        <i class="bi bi-receipt me-1"></i>Fees: {{ financialSummary().feesTotal | currency }}
                    </span>
                </div>
                <div class="col-6 col-md-auto">
                    <span class="badge bg-success-subtle text-success">
                        <i class="bi bi-check-circle-fill me-1"></i>Paid: {{ financialSummary().paidTotal | currency }}
                    </span>
                </div>
                <div class="col-6 col-md-auto">
                    <span class="badge bg-info-subtle text-info">
                        <i class="bi bi-coin me-1"></i>Deposit: {{ financialSummary().depositDueTotal | currency }}
                    </span>
                </div>
                <div class="col-6 col-md-auto">
                    <span class="badge bg-warning-subtle text-warning">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>Balance: {{ financialSummary().additionalDueTotal | currency }}
                    </span>
                </div>
                @if (financialSummary().balanceDue > 0) {
                <div class="col-auto">
                    <span class="badge bg-danger-subtle text-danger">
                        <i class="bi bi-exclamation-circle-fill me-1"></i>Due: {{ financialSummary().balanceDue |
                        currency }}
                    </span>
                </div>
                }
            </div>
        </div>
        }
    </div>

    <!-- Refund Policy Section -->
    @if (refundPolicyHtml()) {
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-warning-subtle">
            <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Refund Policy
            </h5>
        </div>
        <div class="card-body">
            <!-- Policy Content (scrollable) -->
            <div class="policy-content mb-3" [innerHTML]="refundPolicyHtml()"></div>

            <!-- Acceptance Checkbox -->
            <div class="form-check">
                <input 
                    type="checkbox" 
                    class="form-check-input" 
                    id="refundPolicyCheckbox"
                    [checked]="refundPolicyAccepted()"
                    [disabled]="refundPolicyLocked()"
                    [class.is-invalid]="attemptedProceed() && !refundPolicyAccepted()"
                    (change)="onRefundPolicyAcceptanceChange($any($event.target).checked)"
                />
                <label class="form-check-label fw-semibold" for="refundPolicyCheckbox">
                    I have read, understood, and accept the terms of the Refund Policy
                    @if (refundPolicyLocked()) {
                    <span class="badge bg-secondary ms-2">Already Accepted</span>
                    }
                </label>
                @if (attemptedProceed() && !refundPolicyAccepted()) {
                <div class="invalid-feedback d-block">
                    You must accept the Refund Policy to proceed to payment.
                </div>
                }
            </div>
        </div>
    </div>
    }

    <!-- Proceed to Payment Button (only show if teams registered) -->
    @if (registeredTeams().length > 0) {
    <div class="d-grid gap-2 mt-4">
        <button type="button" class="btn btn-primary btn-lg" 
                (click)="proceedToPayment()"
                [disabled]="refundPolicyHtml() && !refundPolicyAccepted()">
            <i class="bi bi-credit-card-fill me-2"></i>
            Proceed to Payment
            @if (financialSummary().balanceDue > 0) {
            <span>({{ financialSummary().balanceDue | currency }} due)</span>
            }
        </button>
    </div>
    }
</div>

<!-- Registration Modal Component -->
<app-team-registration-modal [isOpen]="showRegistrationModal()" [suggestedTeamNames]="suggestedTeamNamesForModal()"
    [ageGroups]="ageGroups()" [availableLevelsOfPlay]="levelsOfPlayOptions()" [isRegistering]="isRegistering()"
    [clubName]="clubName()" (closed)="closeRegistrationModal()" (register)="onTeamRegistered($event)"
    (addAnother)="onTeamAddedAnother($event)">
</app-team-registration-modal>

}
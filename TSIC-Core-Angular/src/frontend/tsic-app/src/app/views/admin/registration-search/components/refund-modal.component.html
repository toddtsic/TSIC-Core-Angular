@if (isOpen()) {
  <div class="modal-overlay" (click)="close()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Process Refund</h3>
        <button type="button" class="btn-close" (click)="close()" [disabled]="isProcessing()">&times;</button>
      </div>

      @if (accountingRecord(); as record) {
        <div class="modal-body">
          <div class="transaction-details">
            <h4>Original Transaction</h4>
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{ record.date | date:'medium' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value">{{ record.paidAmount | currency }}</span>
            </div>
            @if (record.adnCc4) {
              <div class="detail-row">
                <span class="label">Card:</span>
                <span class="value">**** **** **** {{ record.adnCc4 }}</span>
              </div>
            }
            @if (record.adnTransactionId) {
              <div class="detail-row">
                <span class="label">Transaction ID:</span>
                <span class="value">{{ record.adnTransactionId }}</span>
              </div>
            }
          </div>

          <div class="refund-form">
            <div class="form-group">
              <label for="refund-amount">Refund Amount</label>
              <div class="input-group">
                <span class="input-prefix">$</span>
                <input type="number" id="refund-amount" class="form-control"
                  [ngModel]="refundAmount()" (ngModelChange)="refundAmount.set($event)"
                  [max]="record.paidAmount" min="0" step="0.01" [disabled]="isProcessing()" />
              </div>
              <small class="form-text">Maximum: {{ record.paidAmount | currency }}</small>
            </div>
            <div class="form-group">
              <label for="refund-reason">Reason for Refund</label>
              <input type="text" id="refund-reason" class="form-control"
                [ngModel]="reason()" (ngModelChange)="reason.set($event)"
                placeholder="Enter reason (required)" [disabled]="isProcessing()" />
            </div>
          </div>

          <div class="refund-warning">
            <svg class="warning-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5zM11 10v4h2v-4h-2zm0 5v2h2v-2h-2z"/>
            </svg>
            <p>This will credit the cardholder's account. The refund typically appears within 5-10 business days. This action cannot be undone.</p>
          </div>
        </div>

        @if (showConfirm()) {
          <div class="confirm-refund">
            <div class="alert alert-danger mb-0">
              <strong>Confirm Refund</strong>
              <p class="mb-1 mt-1">
                You are about to refund <strong>{{ refundAmount() | currency }}</strong>
                @if (accountingRecord()?.adnCc4) {
                  to card ending in <strong>{{ accountingRecord()?.adnCc4 }}</strong>
                }
              </p>
              <p class="mb-2">This will credit the cardholder's account via Authorize.Net. This action cannot be undone.</p>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-danger" (click)="confirmRefund()">
                  Yes, Refund {{ refundAmount() | currency }}
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="dismissConfirm()">
                  Go Back
                </button>
              </div>
            </div>
          </div>
        }

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="close()" [disabled]="isProcessing()">Cancel</button>
          @if (!showConfirm()) {
            <button type="button" class="btn btn-danger" (click)="requestRefund()" [disabled]="isProcessing()">
              @if (isProcessing()) { <span class="spinner"></span> Processing... } @else { Process Refund }
            </button>
          }
        </div>
      }
    </div>
  </div>
}

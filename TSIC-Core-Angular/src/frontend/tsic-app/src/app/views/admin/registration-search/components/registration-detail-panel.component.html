@if (isOpen()) {
  <div class="detail-backdrop" (click)="close()"></div>
}

<div class="detail-panel" [class.open]="isOpen()">
  @if (detail(); as reg) {
    <div class="panel-header">
      <div class="header-content">
        <h3 class="panel-title">{{ reg.firstName }} {{ reg.lastName }}</h3>
        <div class="header-meta">
          <span class="meta-item">{{ reg.roleName }}</span>
          @if (reg.teamName) {
            <span class="meta-separator">&bull;</span>
            <span class="meta-item">{{ reg.teamName }}</span>
          }
          <span class="meta-separator">&bull;</span>
          <span class="badge" [class.badge-success]="reg.active" [class.badge-secondary]="!reg.active">
            {{ reg.active ? 'Active' : 'Inactive' }}
          </span>
          @if (isPlayerRole()) {
            <button type="button" class="btn btn-sm btn-outline-warning ms-2 change-job-btn"
              (click)="openChangeJobModal()" [disabled]="isLoadingJobOptions()">
              @if (isLoadingJobOptions()) { <span class="spinner-border spinner-border-sm me-1"></span> }
              Change Job
            </button>
          }
          <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-reg-btn"
            (click)="confirmDelete()" [disabled]="isDeleting()">
            Delete
          </button>
        </div>
      </div>
      <button type="button" class="btn-close" (click)="close()" aria-label="Close"></button>
    </div>

    <div class="tab-bar">
      <button type="button" class="tab-button" [class.active]="activeTab() === 'details'" (click)="setActiveTab('details')">Details</button>
      <button type="button" class="tab-button" [class.active]="activeTab() === 'accounting'" (click)="setActiveTab('accounting')">Accounting</button>
      <button type="button" class="tab-button" [class.active]="activeTab() === 'email'" (click)="setActiveTab('email')">Email</button>
    </div>

    <div class="panel-body">
      <!-- ═══════════════════════ DETAILS TAB ═══════════════════════ -->
      @if (activeTab() === 'details') {
        <div class="tab-content">

          <!-- ── Contact Info (editable + read-only identity) ── -->
          <div class="contact-zone">
            <h4 class="section-title">Contact Info</h4>
            <form class="contact-form">
              <div class="contact-row">
                <div class="form-group">
                  <label for="contact-email" class="form-label">Email</label>
                  <input id="contact-email" type="email" class="form-control form-control-sm"
                    [ngModel]="demographics().email" (ngModelChange)="updateDemographicsField('email', $event)"
                    name="email">
                </div>
                <div class="form-group">
                  <label for="contact-cellphone" class="form-label">Cellphone</label>
                  <input id="contact-cellphone" type="tel" class="form-control form-control-sm"
                    [ngModel]="demographics().cellphone" (ngModelChange)="updateDemographicsField('cellphone', $event)"
                    name="cellphone">
                </div>
                @if (isPlayerRole()) {
                  @for (f of ALWAYS_INCLUDE_FIELDS; track f.key) {
                    <div class="form-group">
                      <label [for]="'contact-' + f.key" class="form-label">{{ f.label }}</label>
                      <input [id]="'contact-' + f.key" type="text" class="form-control form-control-sm"
                        [ngModel]="profileValues()[f.key]" (ngModelChange)="updateProfileValue(f.key, $event)"
                        [name]="f.key">
                    </div>
                  }
                }
              </div>

              <!-- Family contact (players with family link) -->
              @if (isPlayerRole() && hasFamilyLink()) {
                <div class="family-contact-row">
                  <div class="family-contact-col">
                    <span class="family-label">{{ reg.momLabel || 'Mom' }}</span>
                    @if (familyName('mom'); as name) {
                      <span class="family-name">{{ name }}</span>
                    }
                    <div class="contact-pair">
                      <div class="form-group">
                        <label for="mom-email" class="form-label">Email</label>
                        <input id="mom-email" type="email" class="form-control form-control-sm"
                          [ngModel]="familyContact().momEmail" (ngModelChange)="updateFamilyField('momEmail', $event)"
                          name="momEmail">
                      </div>
                      <div class="form-group">
                        <label for="mom-cell" class="form-label">Cell</label>
                        <input id="mom-cell" type="tel" class="form-control form-control-sm"
                          [ngModel]="familyContact().momCellphone" (ngModelChange)="updateFamilyField('momCellphone', $event)"
                          name="momCellphone">
                      </div>
                    </div>
                  </div>
                  <div class="family-contact-col">
                    <span class="family-label">{{ reg.dadLabel || 'Dad' }}</span>
                    @if (familyName('dad'); as name) {
                      <span class="family-name">{{ name }}</span>
                    }
                    <div class="contact-pair">
                      <div class="form-group">
                        <label for="dad-email" class="form-label">Email</label>
                        <input id="dad-email" type="email" class="form-control form-control-sm"
                          [ngModel]="familyContact().dadEmail" (ngModelChange)="updateFamilyField('dadEmail', $event)"
                          name="dadEmail">
                      </div>
                      <div class="form-group">
                        <label for="dad-cell" class="form-label">Cell</label>
                        <input id="dad-cell" type="tel" class="form-control form-control-sm"
                          [ngModel]="familyContact().dadCellphone" (ngModelChange)="updateFamilyField('dadCellphone', $event)"
                          name="dadCellphone">
                      </div>
                    </div>
                  </div>
                </div>
              }

              <!-- Demographics (read-only, inline within contact card) -->
              @if (hasValue(demographics().dateOfBirth) || hasValue(demographics().gender) || formatAddress()) {
                <div class="contact-demographics">
                  <div class="info-grid">
                    @if (hasValue(demographics().dateOfBirth)) {
                      <div class="info-item">
                        <span class="info-label">Date of Birth</span>
                        <span class="info-value">{{ demographics().dateOfBirth | date:'mediumDate' }}</span>
                      </div>
                    }
                    @if (hasValue(demographics().gender)) {
                      <div class="info-item">
                        <span class="info-label">Gender</span>
                        <span class="info-value">{{ demographics().gender }}</span>
                      </div>
                    }
                    @if (formatAddress(); as addr) {
                      <div class="info-item info-item-full">
                        <span class="info-label">Address</span>
                        <span class="info-value">{{ addr }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <div class="contact-actions">
                <button type="button" class="btn btn-primary btn-sm" (click)="saveContactInfo()" [disabled]="isSavingContact()">
                  @if (isSavingContact()) { <span class="spinner-border spinner-border-sm me-1"></span> }
                  Save
                </button>
              </div>
            </form>
          </div>

          <!-- ── Read-Only: Registration Info ── -->
          <div class="info-section">
            <h5 class="info-section-title">Registration <span class="reg-id">(Id: <span class="reg-id-guid">{{ reg.registrationId }}</span>)</span></h5>
            <div class="info-grid">
              @if (reg.registrationDate) {
                <div class="info-item">
                  <span class="info-label">Registered</span>
                  <span class="info-value">{{ reg.registrationDate | date:'medium' }}</span>
                </div>
              }
              @if (reg.modifiedDate) {
                <div class="info-item">
                  <span class="info-label">Modified</span>
                  <span class="info-value">{{ reg.modifiedDate | date:'medium' }}</span>
                </div>
              }
            </div>
          </div>

          <!-- ── Read-Only: Player Profile (metadata-driven, only populated fields) ── -->
          @if (isPlayerRole()) {
            @let populatedFields = readOnlyMetadataFields();
            @if (populatedFields.length > 0) {
              <div class="info-section">
                <h5 class="info-section-title">Player Profile</h5>
                <div class="info-grid">
                  @for (field of populatedFields; track field.key) {
                    @if (hasValue(profileValues()[field.key])) {
                      <div class="info-item">
                        <span class="info-label">{{ field.label }}</span>
                        <span class="info-value">
                          @if (field.type === 'checkbox') {
                            {{ formatCheckboxValue(profileValues()[field.key]) }}
                          } @else if (field.type === 'date') {
                            {{ profileValues()[field.key] | date:'mediumDate' }}
                          } @else {
                            {{ profileValues()[field.key] }}
                          }
                        </span>
                      </div>
                    }
                  }
                </div>
              </div>
            }
          }

          <!-- ── Read-Only: Non-Player Info (only populated fields) ── -->
          @if (!isPlayerRole()) {
            @let npFields = nonPlayerFields();
            @if (npFields.length > 0) {
              <div class="info-section">
                <h5 class="info-section-title">Registration Info</h5>
                <div class="info-grid">
                  @for (f of npFields; track f.label) {
                    <div class="info-item" [class.info-item-full]="f.label === 'Special Requests'">
                      <span class="info-label">{{ f.label }}</span>
                      <span class="info-value">{{ f.value }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          }

        </div>
      }

      <!-- ═══════════════════════ ACCOUNTING TAB ═══════════════════════ -->
      @if (activeTab() === 'accounting') {
        <div class="tab-content">
          <div class="financial-summary">
            <div class="summary-item">
              <span class="summary-label">Total Fees:</span>
              <span class="summary-value">{{ getFinancialSummary().fees | currency }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Total Paid:</span>
              <span class="summary-value text-success">{{ getFinancialSummary().paid | currency }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Amount Owed:</span>
              <span class="summary-value" [class.text-danger]="getFinancialSummary().owed > 0">
                {{ getFinancialSummary().owed | currency }}
              </span>
            </div>
          </div>

          @if (reg.accountingRecords && reg.accountingRecords.length > 0) {
            <div class="table-responsive">
              <table class="table table-sm accounting-table">
                <thead>
                  <tr><th>#</th><th>Date</th><th>Method</th><th>Due</th><th>Paid</th><th>Comment</th><th></th></tr>
                </thead>
                <tbody>
                  @for (record of reg.accountingRecords; track record.aId; let idx = $index) {
                    @if (editingAId() === record.aId) {
                      <!-- Inline edit row -->
                      <tr class="editing-row">
                        <td>{{ idx + 1 }}</td>
                        <td>{{ record.date | date:'short' }}</td>
                        <td>{{ record.paymentMethod }}</td>
                        <td>{{ record.dueAmount | currency }}</td>
                        <td>{{ record.paidAmount | currency }}</td>
                        <td>
                          <input type="text" class="form-control form-control-sm inline-edit"
                            [ngModel]="editComment()" (ngModelChange)="editComment.set($event)"
                            placeholder="Comment" [disabled]="isSavingEdit()" />
                          <input type="text" class="form-control form-control-sm inline-edit mt-1"
                            [ngModel]="editCheckNo()" (ngModelChange)="editCheckNo.set($event)"
                            placeholder="Check #" [disabled]="isSavingEdit()" />
                        </td>
                        <td class="edit-actions">
                          <button type="button" class="btn btn-sm btn-success" (click)="saveEditRecord()" [disabled]="isSavingEdit()">Save</button>
                          <button type="button" class="btn btn-sm btn-secondary ms-1" (click)="cancelEditRecord()" [disabled]="isSavingEdit()">Cancel</button>
                        </td>
                      </tr>
                    } @else {
                      <!-- Normal display row -->
                      <tr>
                        <td>{{ idx + 1 }}</td>
                        <td>{{ record.date | date:'short' }}</td>
                        <td>
                          {{ record.paymentMethod }}
                          @if (record.adnCc4) { <span class="text-muted"> (****{{ record.adnCc4 }})</span> }
                        </td>
                        <td>{{ record.dueAmount | currency }}</td>
                        <td>{{ record.paidAmount | currency }}</td>
                        <td><small class="text-muted">{{ record.comment || '—' }}</small></td>
                        <td class="action-cell">
                          @if (record.canRefund) {
                            <button type="button" class="btn btn-sm btn-outline-danger" (click)="onRefundClick(record)">Refund</button>
                          }
                          @if (isEditable(record)) {
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" (click)="startEditRecord(record)">Edit</button>
                          }
                        </td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          } @else {
            <div class="alert alert-info">No accounting records found.</div>
          }

          <div class="form-actions">
            <button type="button" class="btn btn-outline-primary" (click)="openPaymentModal()">+ Add Payment Record</button>
          </div>

          <!-- ARB Subscription Section -->
          @if (reg.hasSubscription) {
            <div class="subscription-section">
              <h4>ARB Subscription</h4>
              @if (isLoadingSubscription()) {
                <div class="text-muted"><span class="spinner-border spinner-border-sm me-1"></span> Loading subscription details...</div>
              } @else if (subscription(); as sub) {
                <div class="subscription-details">
                  <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value">
                      <span class="badge" [class.bg-success]="sub.status === 'active'" [class.bg-secondary]="sub.status !== 'active'">{{ sub.status }}</span>
                    </span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Amount:</span>
                    <span class="value">{{ sub.perOccurrenceAmount | currency }} / {{ sub.intervalLabel }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Schedule:</span>
                    <span class="value">{{ sub.totalOccurrences }} occurrences</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Start:</span>
                    <span class="value">{{ sub.startDate | date:'mediumDate' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Total:</span>
                    <span class="value">{{ sub.totalAmount | currency }}</span>
                  </div>
                </div>
                @if (sub.status === 'active') {
                  <button type="button" class="btn btn-sm btn-outline-danger mt-2" (click)="confirmCancelSubscription()" [disabled]="isCancellingSubscription()">
                    @if (isCancellingSubscription()) { <span class="spinner-border spinner-border-sm me-1"></span> } Cancel Subscription
                  </button>
                }

                <!-- Cancel Subscription Confirmation -->
                @if (showCancelSubConfirm()) {
                  <div class="cancel-sub-confirm mt-3">
                    <div class="alert alert-danger d-flex flex-column gap-2 mb-0">
                      <strong>Are you sure you want to cancel this subscription?</strong>
                      <span>This will permanently cancel the recurring billing ({{ sub.perOccurrenceAmount | currency }} {{ sub.intervalLabel }}) with Authorize.Net. This action cannot be undone.</span>
                      <div class="d-flex gap-2 mt-1">
                        <button type="button" class="btn btn-sm btn-danger" (click)="cancelSubscription()">
                          Yes, Cancel Subscription
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="dismissCancelSubscription()">
                          No, Keep Active
                        </button>
                      </div>
                    </div>
                  </div>
                }
              } @else {
                <div class="text-muted">No subscription details available.</div>
              }
            </div>
          }
        </div>
      }

      <!-- Add Payment Modal -->
      <app-add-payment-modal
        [detail]="detail()"
        [isOpen]="showPaymentModal()"
        (closed)="showPaymentModal.set(false)"
        (paymentRecorded)="onPaymentRecorded()"
      ></app-add-payment-modal>

      <!-- ═══════════════════════ EMAIL TAB ═══════════════════════ -->
      @if (activeTab() === 'email') {
        <div class="tab-content">
          <form class="email-form">
            <div class="token-chips">
              <span class="token-label">Insert Token:</span>
              <button type="button" class="token-chip" (click)="insertEmailToken('!PERSON')">!PERSON</button>
              <button type="button" class="token-chip" (click)="insertEmailToken('!EMAIL')">!EMAIL</button>
              <button type="button" class="token-chip" (click)="insertEmailToken('!JOBNAME')">!JOBNAME</button>
              <button type="button" class="token-chip" (click)="insertEmailToken('!AMTFEES')">!AMTFEES</button>
              <button type="button" class="token-chip" (click)="insertEmailToken('!AMTPAID')">!AMTPAID</button>
              <button type="button" class="token-chip" (click)="insertEmailToken('!AMTOWED')">!AMTOWED</button>
            </div>
            <div class="form-group">
              <label for="email-subject" class="form-label">Subject</label>
              <input id="email-subject" type="text" class="form-control"
                [ngModel]="emailSubject()" (ngModelChange)="emailSubject.set($event)"
                name="subject" placeholder="Enter email subject">
            </div>
            <div class="form-group">
              <label for="email-body" class="form-label">Message</label>
              <textarea id="email-body" class="form-control"
                [ngModel]="emailBody()" (ngModelChange)="emailBody.set($event)"
                name="body" rows="8" placeholder="Enter email message (use tokens like !PERSON, !AMTOWED, etc.)"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-primary" (click)="sendEmail()" [disabled]="!emailSubject() || !emailBody()">Send Email</button>
            </div>
          </form>
        </div>
      }
    </div>

    <!-- ═══════════════════════ CHANGE JOB MODAL ═══════════════════════ -->
    @if (showChangeJobModal()) {
      <div class="modal-backdrop" (click)="cancelChangeJob()"></div>
      <div class="change-job-modal">
        <div class="modal-header">
          <h4 class="modal-title">Change Registrant's Job</h4>
          <button type="button" class="btn-close" (click)="cancelChangeJob()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="new-job-select" class="form-label">To:</label>
            <select id="new-job-select" class="form-select"
              [ngModel]="selectedNewJobId()" (ngModelChange)="selectedNewJobId.set($event)"
              name="newJobId">
              <option value="">--select from list--</option>
              @for (job of changeJobOptions(); track job.jobId) {
                <option [value]="job.jobId">{{ job.jobName }}</option>
              }
            </select>
          </div>
          @if (changeJobOptions().length === 0) {
            <div class="alert alert-info mt-2">No other jobs found for this customer.</div>
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelChangeJob()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="submitChangeJob()"
            [disabled]="!selectedNewJobId() || isChangingJob()">
            @if (isChangingJob()) { <span class="spinner-border spinner-border-sm me-1"></span> }
            Submit
          </button>
        </div>
      </div>
    }

    <!-- ═══════════════════════ DELETE REGISTRATION MODAL ═══════════════════════ -->
    @if (showDeleteConfirm()) {
      <div class="modal-backdrop" (click)="cancelDelete()"></div>
      <div class="delete-confirm-modal">
        <div class="modal-header modal-header-danger">
          <h4 class="modal-title">Delete Registration</h4>
          <button type="button" class="btn-close" (click)="cancelDelete()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="delete-warning">
            Are you sure you want to permanently delete this registration for
            <strong>{{ reg.firstName }} {{ reg.lastName }}</strong> ({{ reg.roleName }})?
          </p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="executeDelete()"
            [disabled]="isDeleting()">
            @if (isDeleting()) { <span class="spinner-border spinner-border-sm me-1"></span> }
            Delete Registration
          </button>
        </div>
      </div>
    }
  }
</div>

<!-- Reusable multiselect item template for count badges -->
<ng-template #countBadgeTemplate let-data>
  <span class="filter-item">
    <span class="filter-item-text">{{ data.text }}</span>
    <span class="filter-item-count">{{ data.count }}</span>
  </span>
</ng-template>

<!-- Desktop View -->
@if (!isMobile()) {
  <div class="registration-search-container">
    <!-- Filter Panel -->
    <div class="filter-panel">
      <!-- Compact Bar (always visible) -->
      <div class="filter-bar-compact">
        <div class="filter-row">
          <div class="form-group">
            <label>Role</label>
            <ejs-multiselect
              [dataSource]="filterOptions()?.roles ?? []"
              [fields]="msFields"
              [value]="searchRequest().roleIds"
              (change)="updateMultiSelect('roleIds', $event.value)"
              [mode]="'CheckBox'"
              [showSelectAll]="true"
              [showDropDownIcon]="true"
              [closePopupOnSelect]="false"
              [changeOnBlur]="false"
              placeholder="All Roles"
              [itemTemplate]="countBadgeTemplate"
              cssClass="filter-ms"
              [popupWidth]="'auto'">
            </ejs-multiselect>
          </div>

          <div class="form-group">
            <label>Pay Status</label>
            <ejs-multiselect
              [dataSource]="filterOptions()?.payStatuses ?? []"
              [fields]="msFields"
              [value]="searchRequest().payStatuses"
              (change)="updateMultiSelect('payStatuses', $event.value)"
              [mode]="'CheckBox'"
              [showDropDownIcon]="true"
              [closePopupOnSelect]="false"
              [changeOnBlur]="false"
              placeholder="All"
              [itemTemplate]="countBadgeTemplate"
              cssClass="filter-ms"
              [popupWidth]="'auto'">
            </ejs-multiselect>
          </div>

          <div class="form-group">
            <label>Position</label>
            <ejs-multiselect
              [dataSource]="filterOptions()?.positions ?? []"
              [fields]="msFields"
              [value]="searchRequest().positions"
              (change)="updateMultiSelect('positions', $event.value)"
              [mode]="'CheckBox'"
              [showDropDownIcon]="true"
              [closePopupOnSelect]="false"
              [changeOnBlur]="false"
              placeholder="All"
              [itemTemplate]="countBadgeTemplate"
              cssClass="filter-ms"
              [popupWidth]="'auto'">
            </ejs-multiselect>
          </div>

          <div class="form-group">
            <label>Grad Year</label>
            <ejs-multiselect
              [dataSource]="filterOptions()?.gradYears ?? []"
              [fields]="msFields"
              [value]="searchRequest().gradYears"
              (change)="updateMultiSelect('gradYears', $event.value)"
              [mode]="'CheckBox'"
              [showDropDownIcon]="true"
              [closePopupOnSelect]="false"
              [changeOnBlur]="false"
              placeholder="All"
              [itemTemplate]="countBadgeTemplate"
              cssClass="filter-ms"
              [popupWidth]="'auto'">
            </ejs-multiselect>
          </div>
        </div>

        <!-- LADT Tree (essential) -->
        <div class="filter-row-ladt">
          <div class="form-group form-group-tree">
            <label>League / Agegroup / Division / Team</label>
            <div class="tree-scroll-container">
              <app-ladt-tree-filter
                [treeData]="ladtTree()"
                [checkedIds]="ladtCheckedIds()"
                (checkedIdsChange)="onLadtCheckedChange($event)">
              </app-ladt-tree-filter>
            </div>
          </div>
        </div>

        <!-- Action buttons row -->
        <div class="action-row">
          <div class="action-buttons">
            <button type="button"
              class="btn"
              [class.btn-primary]="!filtersAreDirty()"
              [class.btn-warning]="filtersAreDirty()"
              [class.search-dirty]="filtersAreDirty()"
              (click)="executeSearch()"
              [disabled]="isSearching()">
              @if (isSearching()) { <span class="spinner-border spinner-border-sm me-1"></span> }
              @if (filtersAreDirty() && searchResults()) { Update Results } @else { Search }
            </button>
            <button type="button" class="btn btn-secondary" (click)="clearFilters()">Clear</button>
            <button type="button" class="btn btn-outline-secondary" (click)="toggleMoreFilters()">
              @if (moreFiltersExpanded()) { Less Filters } @else { More Filters }
              <svg class="toggle-arrow" [class.expanded]="moreFiltersExpanded()" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>
          <div class="action-buttons-right">
            <button type="button" class="btn btn-info" (click)="onEmailSelected()" [disabled]="!canEmailSelected">
              Email Selected
            </button>
            <button type="button" class="btn btn-success" (click)="exportExcel()" [disabled]="!searchResults()?.result?.length">Export</button>
          </div>
        </div>
      </div>

      <!-- Expandable "More Filters" -->
      @if (moreFiltersExpanded()) {
        <div class="filter-bar-expanded">
          <!-- Section: General -->
          <div class="filter-section">
            <div class="section-label">General</div>
            <div class="filter-row">
              <div class="form-group">
                <label for="filterName">Name</label>
                <input type="text" id="filterName" class="form-control"
                  placeholder="First or Last"
                  [ngModel]="searchRequest().name"
                  (ngModelChange)="updateName($event)" />
              </div>
              <div class="form-group">
                <label for="filterEmail">Email</label>
                <input type="text" id="filterEmail" class="form-control"
                  placeholder="Email address"
                  [ngModel]="searchRequest().email"
                  (ngModelChange)="updateEmail($event)" />
              </div>
              <div class="form-group">
                <label for="filterPhone">Phone</label>
                <input type="text" id="filterPhone" class="form-control"
                  placeholder="Cell phone"
                  [ngModel]="searchRequest().phone"
                  (ngModelChange)="updatePhone($event)" />
              </div>
              <div class="form-group">
                <label>Status</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.activeStatuses ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().activeStatuses"
                  (change)="updateMultiSelect('activeStatuses', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All Statuses"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms"
                  [popupWidth]="'auto'">
                </ejs-multiselect>
              </div>
              <div class="form-group">
                <label for="filterDateFrom">Date From</label>
                <input type="date" id="filterDateFrom" class="form-control"
                  [ngModel]="searchRequest().regDateFrom"
                  (ngModelChange)="updateRegDateFrom($event)" />
              </div>
              <div class="form-group">
                <label for="filterDateTo">Date To</label>
                <input type="date" id="filterDateTo" class="form-control"
                  [ngModel]="searchRequest().regDateTo"
                  (ngModelChange)="updateRegDateTo($event)" />
              </div>
            </div>
          </div>

          <!-- Section: Organization -->
          <div class="filter-section">
            <div class="section-label">Organization</div>
            <div class="filter-row">
              <div class="form-group">
                <label for="filterSchool">School</label>
                <input type="text" id="filterSchool" class="form-control"
                  placeholder="School name"
                  [ngModel]="searchRequest().schoolName"
                  (ngModelChange)="updateSchoolName($event)" />
              </div>
              <div class="form-group">
                <label>Club</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.clubs ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().clubNames"
                  (change)="updateMultiSelect('clubNames', $event.value)"
                  [mode]="'CheckBox'"
                  [showSelectAll]="true"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  [enableFiltering]="true"
                  placeholder="All Clubs"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
            </div>
          </div>

          <!-- Section: Demographics -->
          <div class="filter-section">
            <div class="section-label">Demographics</div>
            <div class="filter-row">
              <div class="form-group">
                <label>Gender</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.genders ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().genders"
                  (change)="updateMultiSelect('genders', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
              <div class="form-group">
                <label>Grade</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.grades ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().grades"
                  (change)="updateMultiSelect('grades', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
              <div class="form-group">
                <label>Age Range</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.ageRanges ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().ageRangeIds"
                  (change)="updateMultiSelect('ageRangeIds', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
            </div>
          </div>

          <!-- Section: Billing & Mobile -->
          <div class="filter-section">
            <div class="section-label">Billing &amp; Mobile</div>
            <div class="filter-row">
              <div class="form-group">
                <label>ARB Subscription</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.arbSubscriptionStatuses ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().arbSubscriptionStatuses"
                  (change)="updateMultiSelect('arbSubscriptionStatuses', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
              <div class="form-group">
                <label>Mobile Registrations</label>
                <ejs-multiselect
                  [dataSource]="filterOptions()?.mobileRegistrations ?? []"
                  [fields]="msFields"
                  [value]="searchRequest().mobileRegistrationRoles"
                  (change)="updateMultiSelect('mobileRegistrationRoles', $event.value)"
                  [mode]="'CheckBox'"
                  [showDropDownIcon]="true"
                  [closePopupOnSelect]="false"
                  [changeOnBlur]="false"
                  placeholder="All"
                  [itemTemplate]="countBadgeTemplate"
                  cssClass="filter-ms">
                </ejs-multiselect>
              </div>
            </div>
          </div>

          <!-- Section: Club Roster Search -->
          <div class="filter-section">
            <div class="section-label">Club Roster Search</div>
            <div class="filter-row">
              <div class="form-group">
                <label for="rosterThreshold">Teams With Roster Count &lt;=</label>
                <select id="rosterThreshold" class="form-select"
                  [ngModel]="searchRequest().rosterThreshold ?? ''"
                  (ngModelChange)="updateRosterThreshold($event)">
                  <option value="">-- Not Filtered --</option>
                  <option [ngValue]="0">0</option>
                  <option [ngValue]="1">1</option>
                  <option [ngValue]="2">2</option>
                  <option [ngValue]="3">3</option>
                  <option [ngValue]="5">5</option>
                  <option [ngValue]="10">10</option>
                  <option [ngValue]="15">15</option>
                  <option [ngValue]="20">20</option>
                  <option [ngValue]="25">25</option>
                </select>
              </div>
              <div class="form-group">
                <label for="rosterClub">Club (optional)</label>
                <select id="rosterClub" class="form-select"
                  [ngModel]="searchRequest().rosterThresholdClub ?? ''"
                  (ngModelChange)="updateRosterThresholdClub($event)">
                  <option value="">All Clubs</option>
                  @for (club of filterOptions()?.clubs ?? []; track club.value) {
                    <option [value]="club.value">{{ club.text }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Filter Chips Strip -->
    @if (activeFilterChips().length > 0 && searchResults()) {
      <div class="filter-chips-strip">
        @for (chip of activeFilterChips(); track chip.filterKey + chip.value) {
          <span class="filter-chip">
            <span class="chip-category">{{ chip.category }}:</span>
            <span class="chip-label">{{ chip.label }}</span>
            <button type="button" class="chip-remove" (click)="removeFilterChip(chip)" aria-label="Remove filter">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </span>
        }
        <button type="button" class="chip-clear-all" (click)="clearAllChips()">Clear All</button>
      </div>
    }

    <!-- Results Grid -->
    <div class="results-container">
      @if (searchResults()) {
        <div class="results-summary">
          <span class="result-count">
            {{ searchResults()!.count }} registration(s) found
          </span>
        </div>

        <ejs-grid
          #grid
          [dataSource]="searchResults()!.result"
          [allowPaging]="true"
          [allowSorting]="true"
          [allowExcelExport]="true"
          [frozenColumns]="4"
          [pageSettings]="pageSettings"
          [sortSettings]="sortSettings"
          (rowSelected)="onRowSelected()"
          (rowDeselected)="onRowSelected()"
          (queryCellInfo)="queryCellInfo($event)"
          class="tight-table"
        >
          <e-columns>
            <!-- Frozen columns (checkbox, Row, Name, Active) -->
            <e-column type="checkbox" width="40"></e-column>
            <e-column headerText="Row" width="55" textAlign="Center" [allowSorting]="false"></e-column>
            <e-column field="lastName" headerText="Name" width="170">
              <ng-template #template let-data>
                <a href="javascript:void(0)" (click)="openDetail(data.registrationId)" class="detail-link">
                  {{ data.lastName }}, {{ data.firstName }}
                </a>
              </ng-template>
            </e-column>
            <e-column field="active" headerText="Active" width="70" textAlign="Center">
              <ng-template #template let-data>
                @if (data.active) {
                  <span class="badge bg-success">Yes</span>
                } @else {
                  <span class="badge bg-secondary">No</span>
                }
              </ng-template>
            </e-column>

            <!-- Scrollable columns -->
            <e-column field="registrationTs" headerText="RegDate" width="100" type="date" format="M/d/yyyy"></e-column>
            <e-column field="roleName" headerText="Role" width="100"></e-column>
            <e-column field="phone" headerText="CellPhone" width="120"></e-column>
            <e-column field="dob" headerText="Dob" width="100" type="date" format="M/d/yyyy"></e-column>
            <e-column field="position" headerText="Psn" width="80"></e-column>
            <e-column field="paidTotal" headerText="$Paid" width="90" textAlign="Right" format="C2"></e-column>
            <e-column field="owedTotal" headerText="$Owed" width="90" textAlign="Right" format="C2"></e-column>
            <e-column field="teamName" headerText="Assignment" width="160"></e-column>
          </e-columns>

          <e-aggregates>
            <e-aggregate>
              <e-columns>
                <e-column field="paidTotal" type="Custom">
                  <ng-template #footerTemplate>
                    <div class="aggregate-value">{{ searchResults()!.totalPaid | currency }}</div>
                  </ng-template>
                </e-column>
                <e-column field="owedTotal" type="Custom">
                  <ng-template #footerTemplate>
                    <div class="aggregate-value">{{ searchResults()!.totalOwed | currency }}</div>
                  </ng-template>
                </e-column>
              </e-columns>
            </e-aggregate>
          </e-aggregates>
        </ejs-grid>
      }
    </div>
  </div>
}

<!-- Mobile View -->
@if (isMobile()) {
  <app-mobile-quick-lookup></app-mobile-quick-lookup>
}

<!-- Detail Panel -->
@if (isPanelOpen()) {
  <app-registration-detail-panel
    [detail]="selectedDetail()"
    [isOpen]="isPanelOpen()"
    (closed)="closePanel()"
    (refundRequested)="onRefundRequested($event)"
  ></app-registration-detail-panel>
}

<!-- Refund Modal -->
@if (showRefundModal()) {
  <app-refund-modal
    [accountingRecord]="refundTarget()"
    [isOpen]="showRefundModal()"
    (closed)="showRefundModal.set(false)"
    (refunded)="onRefundComplete()"
  ></app-refund-modal>
}

<!-- Batch Email Modal -->
@if (showBatchEmailModal()) {
  <app-batch-email-modal
    [registrationIds]="selectedRegistrationIds"
    [recipientCount]="selectedRegistrations().size"
    [isOpen]="showBatchEmailModal()"
    (closed)="showBatchEmailModal.set(false)"
    (sent)="onBatchEmailComplete()"
  ></app-batch-email-modal>
}

<div class="nav-editor-container">
	<h4 class="mb-3">Nav Editor</h4>
	<p class="text-muted mb-4">
		Build platform-default navigation menus per role. Use the legacy panel to import existing menu structures.
	</p>

	@if (error()) {
		<div class="alert alert-danger">{{ error() }}</div>
	}

	@if (isLoading()) {
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
	}

	<div class="row g-4">
		<!-- ═══ LEFT PANEL: Legacy Menu Viewer ═══ -->
		<div class="col-lg-5">
			<div class="card shadow-sm">
				<div class="card-header bg-surface d-flex align-items-center justify-content-between">
					<h6 class="mb-0">
						<i class="bi bi-clock-history me-2"></i>Legacy Menus
					</h6>
					<span class="badge bg-secondary">Read-Only</span>
				</div>
				<div class="card-body">
					<!-- Role selector -->
					<div class="mb-3">
						<label class="form-label fw-medium">Select Role</label>
						<select
							class="form-select form-select-sm"
							[ngModel]="selectedLegacyRoleId()"
							(ngModelChange)="selectLegacyRole($event)">
							<option [ngValue]="null" disabled>Choose a role...</option>
							@for (role of legacyRoles(); track role.roleId) {
								<option [ngValue]="role.roleId">{{ role.roleName }}</option>
							}
						</select>
					</div>

					@if (selectedLegacyMenu(); as menu) {
						<!-- Import button -->
						<div class="mb-3">
							<button
								class="btn btn-sm btn-outline-primary w-100"
								(click)="importLegacyMenu(menu)"
								[disabled]="isLoading()">
								<i class="bi bi-box-arrow-in-right me-1"></i>
								Import All to Nav
							</button>
						</div>

						<!-- Legacy menu tree -->
						<div class="legacy-tree">
							@for (parent of menu.items; track parent.menuItemId) {
								<div class="legacy-parent" [class.inactive]="!parent.active">
									<div class="d-flex align-items-center gap-2 py-1">
										@if (parent.iconName) {
											<i class="bi bi-{{ parent.iconName }}"></i>
										}
										<span class="fw-medium">{{ parent.text }}</span>
										@if (!parent.active) {
											<span class="badge bg-secondary badge-sm">inactive</span>
										}
									</div>
									<div class="text-muted small ms-4">{{ getLegacyRoute(parent) }}</div>

									@for (child of parent.children; track child.menuItemId) {
										<div class="legacy-child ms-4 py-1" [class.inactive]="!child.active">
											<div class="d-flex align-items-center gap-2">
												@if (child.iconName) {
													<i class="bi bi-{{ child.iconName }} text-muted"></i>
												}
												<span>{{ child.text }}</span>
												@if (!child.active) {
													<span class="badge bg-secondary badge-sm">inactive</span>
												}
											</div>
											<div class="text-muted small ms-4">{{ getLegacyRoute(child) }}</div>
										</div>
									}
								</div>
							}

							@if (menu.items.length === 0) {
								<div class="text-muted text-center py-3">No menu items</div>
							}
						</div>
					} @else {
						<div class="text-muted text-center py-3">Select a role to view legacy menu</div>
					}
				</div>
			</div>
		</div>

		<!-- ═══ RIGHT PANEL: New Nav Editor ═══ -->
		<div class="col-lg-7">
			<div class="card shadow-sm">
				<div class="card-header bg-surface d-flex align-items-center justify-content-between">
					<h6 class="mb-0">
						<i class="bi bi-signpost-split me-2"></i>Platform Nav Defaults
					</h6>
					<span class="badge bg-primary">Editable</span>
				</div>
				<div class="card-body">
					<!-- Role tabs -->
					<div class="d-flex flex-wrap gap-1 mb-3">
						@for (role of navRoles(); track role.roleId) {
							<button
								class="btn btn-sm"
								[class.btn-primary]="selectedNavRoleId() === role.roleId"
								[class.btn-outline-secondary]="selectedNavRoleId() !== role.roleId"
								(click)="selectNavRole(role.roleId)">
								{{ role.roleName }}
							</button>
						}
					</div>

					@if (selectedNav(); as nav) {
						<!-- Add root item button -->
						<div class="mb-3">
							<button
								class="btn btn-sm btn-outline-success"
								(click)="addRootItem(nav.navId)">
								<i class="bi bi-plus-circle me-1"></i>
								Add Section
							</button>
						</div>

						<!-- Nav item tree -->
						@for (parent of nav.items; track parent.navItemId) {
							<div class="nav-parent mb-2" [class.inactive]="!parent.active">
								@if (editingItemId() === parent.navItemId) {
									<!-- Editing mode -->
									<div class="edit-form p-2 border rounded bg-light">
										<div class="row g-2 mb-2">
											<div class="col-6">
												<input class="form-control form-control-sm" placeholder="Text"
													[ngModel]="editText()" (ngModelChange)="editText.set($event)">
											</div>
											<div class="col-3">
												<input class="form-control form-control-sm" placeholder="Icon"
													[ngModel]="editIconName()" (ngModelChange)="editIconName.set($event)">
											</div>
											<div class="col-3">
												<div class="form-check form-switch mt-1">
													<input class="form-check-input" type="checkbox"
														[ngModel]="editActive()" (ngModelChange)="editActive.set($event)">
													<label class="form-check-label small">Active</label>
												</div>
											</div>
										</div>
										<div class="row g-2 mb-2">
											<div class="col-6">
												<input class="form-control form-control-sm" placeholder="RouterLink"
													[ngModel]="editRouterLink()" (ngModelChange)="editRouterLink.set($event)">
											</div>
											<div class="col-6">
												<input class="form-control form-control-sm" placeholder="NavigateUrl"
													[ngModel]="editNavigateUrl()" (ngModelChange)="editNavigateUrl.set($event)">
											</div>
										</div>
										<div class="d-flex gap-1">
											<button class="btn btn-sm btn-primary" (click)="saveEdit(parent.navItemId)">Save</button>
											<button class="btn btn-sm btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
										</div>
									</div>
								} @else {
									<!-- Display mode -->
									<div class="d-flex align-items-center gap-2 py-1 px-2 nav-item-row">
										<i class="bi bi-grip-vertical text-muted"></i>
										@if (parent.iconName) {
											<i class="bi bi-{{ parent.iconName }}"></i>
										}
										<span class="fw-medium flex-grow-1">{{ parent.text }}</span>
										@if (parent.routerLink) {
											<span class="text-muted small">{{ parent.routerLink }}</span>
										}
										@if (!parent.active) {
											<span class="badge bg-secondary badge-sm">inactive</span>
										}
										<div class="btn-group btn-group-sm">
											<button class="btn btn-outline-secondary btn-sm" title="Edit" (click)="startEdit(parent)">
												<i class="bi bi-pencil"></i>
											</button>
											<button class="btn btn-outline-secondary btn-sm" title="Add child" (click)="addChildItem(nav.navId, parent.navItemId)">
												<i class="bi bi-plus"></i>
											</button>
											<button class="btn btn-outline-secondary btn-sm" title="Toggle active" (click)="toggleActive(parent)">
												<i class="bi" [class.bi-eye]="parent.active" [class.bi-eye-slash]="!parent.active"></i>
											</button>
											<button class="btn btn-outline-danger btn-sm" title="Delete" (click)="deleteItem(parent.navItemId)">
												<i class="bi bi-trash"></i>
											</button>
										</div>
									</div>
								}

								<!-- Children -->
								@for (child of parent.children; track child.navItemId) {
									<div class="ms-4" [class.inactive]="!child.active">
										@if (editingItemId() === child.navItemId) {
											<div class="edit-form p-2 border rounded bg-light">
												<div class="row g-2 mb-2">
													<div class="col-5">
														<input class="form-control form-control-sm" placeholder="Text"
															[ngModel]="editText()" (ngModelChange)="editText.set($event)">
													</div>
													<div class="col-2">
														<input class="form-control form-control-sm" placeholder="Icon"
															[ngModel]="editIconName()" (ngModelChange)="editIconName.set($event)">
													</div>
													<div class="col-3">
														<input class="form-control form-control-sm" placeholder="RouterLink"
															[ngModel]="editRouterLink()" (ngModelChange)="editRouterLink.set($event)">
													</div>
													<div class="col-2">
														<div class="form-check form-switch mt-1">
															<input class="form-check-input" type="checkbox"
																[ngModel]="editActive()" (ngModelChange)="editActive.set($event)">
															<label class="form-check-label small">Active</label>
														</div>
													</div>
												</div>
												<div class="d-flex gap-1">
													<button class="btn btn-sm btn-primary" (click)="saveEdit(child.navItemId)">Save</button>
													<button class="btn btn-sm btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
												</div>
											</div>
										} @else {
											<div class="d-flex align-items-center gap-2 py-1 px-2 nav-item-row">
												<i class="bi bi-grip-vertical text-muted"></i>
												@if (child.iconName) {
													<i class="bi bi-{{ child.iconName }} text-muted"></i>
												}
												<span class="flex-grow-1">{{ child.text }}</span>
												@if (child.routerLink) {
													<span class="text-muted small">{{ child.routerLink }}</span>
												}
												@if (!child.active) {
													<span class="badge bg-secondary badge-sm">inactive</span>
												}
												<div class="btn-group btn-group-sm">
													<button class="btn btn-outline-secondary btn-sm" title="Edit" (click)="startEdit(child)">
														<i class="bi bi-pencil"></i>
													</button>
													<button class="btn btn-outline-secondary btn-sm" title="Toggle active" (click)="toggleActive(child)">
														<i class="bi" [class.bi-eye]="child.active" [class.bi-eye-slash]="!child.active"></i>
													</button>
													<button class="btn btn-outline-danger btn-sm" title="Delete" (click)="deleteItem(child.navItemId)">
														<i class="bi bi-trash"></i>
													</button>
												</div>
											</div>
										}
									</div>
								}
							</div>
						}

						@if (nav.items.length === 0) {
							<div class="text-muted text-center py-3">
								No nav items yet. Add a section or import from legacy.
							</div>
						}
					} @else if (navDefaults().length === 0) {
						<div class="text-muted text-center py-4">
							<p>No platform defaults created yet.</p>
							<p>Import from legacy menus or create defaults for each role.</p>
						</div>
					} @else {
						<div class="text-muted text-center py-3">Select a role tab above</div>
					}
				</div>
			</div>
		</div>
	</div>
</div>

<div class="schedule-div-container">

    <!-- ── Header ── -->
    <div class="schedule-header">
        <h5 class="mb-0">Schedule by Division</h5>
    </div>

    <!-- ── Main layout: Navigator+Pairings (left) | Schedule Grid (right) ── -->
    <div class="schedule-layout">

        <!-- ══════════ LEFT PANEL: Navigator + Pairings ══════════ -->
        <div class="left-panel">

            <!-- ── Division Navigator ── -->
            <div class="nav-panel">
                <div class="panel-header">
                    <span class="fw-semibold">Agegroup/Divisions</span>
                </div>
                <app-division-navigator
                    [agegroups]="agegroups()"
                    [selectedDivId]="selectedDivision()?.divId ?? null"
                    [isLoading]="isNavLoading()"
                    [showCollapseAll]="true"
                    (divisionSelected)="onDivisionSelected($event)" />
            </div>

            <!-- ── Pairings Panel (below navigator) ── -->
            @if (selectedDivision()) {
                <div class="pairings-panel">
                    <div class="panel-header d-flex align-items-center justify-content-between">
                        <span class="fw-semibold">Pairings</span>
                        <div class="d-flex align-items-center gap-1">
                            @if (selectedPairing()) {
                                <span class="badge bg-success-subtle text-success-emphasis">
                                    <i class="bi bi-cursor-fill me-1"></i>Click open slot to place
                                </span>
                            }
                            <div class="placement-mode-toggle">
                                <span class="placement-mode-label">Schedule by:</span>
                                <div class="placement-mode-pill">
                                    <button class="pill-seg"
                                            [class.pill-seg-active]="placementMode() === 'mouse'"
                                            (click)="setPlacementMode('mouse')">
                                        Mouse
                                    </button>
                                    <button class="pill-seg"
                                            [class.pill-seg-active]="placementMode() === 'keyboard'"
                                            (click)="setPlacementMode('keyboard')">
                                        Keyboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (isPairingsLoading()) {
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary"></div>
                        </div>
                    } @else {
                        <div class="panel-body pairings-body">
                            @for (p of pairings(); track p.ai) {
                                <div class="pairing-row"
                                     [class.pairing-selected]="isPairingSelected(p)"
                                     [class.pairing-scheduled]="!p.bAvailable"
                                     (click)="p.bAvailable ? onPairingClick(p) : null">
                                    <span class="pairing-gno">G{{ p.gameNumber }}</span>
                                    <span class="pairing-teams">{{ teamDes(p.t1Type, p.t1) }} vs {{ teamDes(p.t2Type, p.t2) }}</span>
                                    <span class="pairing-rnd">R{{ p.rnd }}</span>
                                    @if (p.bAvailable) {
                                        <button class="pairing-pick-btn" title="Select for placement"
                                                (click)="onPairingClick(p); $event.stopPropagation()">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                    } @else {
                                        <i class="bi bi-check-circle-fill pairing-scheduled-icon"></i>
                                    }
                                </div>
                            }

                            @if (pairings().length === 0) {
                                <div class="empty-state-sm">
                                    <p class="text-secondary mb-0">No pairings for this division</p>
                                </div>
                            }
                        </div>
                    }

                    <!-- Teams toggle -->
                    @if (divisionTeams().length > 0) {
                        <div class="section-label-toggle" (click)="toggleTeams()">
                            <i class="bi me-1"
                               [class.bi-chevron-down]="showTeams()"
                               [class.bi-chevron-right]="!showTeams()"></i>
                            Teams ({{ divisionTeams().length }})
                        </div>
                        @if (showTeams()) {
                            <div class="teams-list">
                                @for (team of divisionTeams(); track team.teamId) {
                                    <div class="team-row">
                                        <span class="team-rank">{{ team.divRank }}</span>
                                        <span class="team-name">{{ team.teamName }}</span>
                                        <span class="team-club text-secondary">{{ team.clubName }}</span>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            }
        </div>

        <!-- ══════════ RIGHT PANEL: Schedule Grid ══════════ -->
        <div class="grid-panel">
            @if (!selectedDivision()) {
                <div class="empty-state">
                    <i class="bi bi-calendar3 text-secondary icon-lg"></i>
                    <p class="text-secondary mt-2 mb-0">Select a division to view the schedule grid</p>
                </div>
            } @else {
                <app-schedule-grid #scheduleGrid
                    [gridResponse]="gridResponse()"
                    [isLoading]="isGridLoading()"
                    [emptyMessage]="'No fields or timeslots configured for this division'"
                    [showMatchupCodes]="true"
                    [showGameId]="true"
                    [showTeamDesignators]="true"
                    [showActionButtons]="true"
                    [highlightDivId]="selectedDivision()?.divId ?? null"
                    [selectedGameGid]="selectedGame()?.game?.gid ?? null"
                    [showOpenSlotHints]="!!selectedPairing()"
                    [showMoveSlotHints]="!!selectedGame()"
                    (cellClicked)="onGridCellClick($event)"
                    (gameMoveRequested)="selectGameForMove($event.game, $event.row, $event.colIndex)"
                    (gameDeleteRequested)="deleteGame($event.game, $event.row, $event.colIndex)">

                    <!-- Projected into grid header title area -->
                    <span gridTitle class="fw-semibold">{{ selectedDivision()!.divName }}</span>
                    <span gridTitle class="badge bg-primary-subtle text-primary-emphasis">
                        {{ teamCount() }} teams
                    </span>

                    <!-- Projected into grid header actions area -->
                    <button gridActions class="btn btn-sm btn-outline-danger"
                            (click)="confirmDeleteDivGames()"
                            [disabled]="isDeletingDivGames()"
                            title="Delete all games for this division">
                        @if (isDeletingDivGames()) {
                            <span class="spinner-border spinner-border-sm"></span>
                        } @else {
                            <i class="bi bi-trash"></i>
                        }
                        Clear Div
                    </button>

                    <!-- Projected below grid header -->
                    @if (showDeleteDivConfirm()) {
                        <div gridExtra class="alert alert-danger m-2 mb-0 py-1 px-2 d-flex align-items-center justify-content-between">
                            <span>
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Delete <strong>all</strong> scheduled games for <strong>{{ selectedDivision()!.divName }}</strong>?
                            </span>
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-danger" (click)="deleteDivGames()">Yes, Delete All</button>
                                <button class="btn btn-sm btn-outline-secondary" (click)="cancelDeleteDivGames()">Cancel</button>
                            </div>
                        </div>
                    }
                </app-schedule-grid>
            }
        </div>
    </div>
</div>

<!-- ══════════ Rapid-Placement Modal ══════════ -->
@if (showRapidModal()) {
    <tsic-dialog [open]="true" size="sm" (requestClose)="closeRapidModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rapid Placement</h5>
                <span class="badge bg-secondary-subtle text-secondary-emphasis ms-2">
                    {{ remainingPairingsCount() }} remaining
                </span>
                <button type="button" class="btn-close ms-auto" (click)="closeRapidModal()"></button>
            </div>
            <div class="modal-body">
                <!-- Current pairing (read-only) -->
                @if (rapidPairing()) {
                    <div class="rapid-pairing-label">
                        <span class="fw-semibold">G{{ rapidPairing()!.gameNumber }}:</span>
                        {{ teamDes(rapidPairing()!.t1Type, rapidPairing()!.t1) }}
                        vs
                        {{ teamDes(rapidPairing()!.t2Type, rapidPairing()!.t2) }}
                        <span class="text-secondary ms-1">R{{ rapidPairing()!.rnd }}</span>
                    </div>

                    <!-- Field typeahead -->
                    <div class="rapid-field mb-2">
                        <label class="form-label form-label-sm mb-1">Field</label>
                        <div class="rapid-typeahead">
                            <input #rapidFieldInput type="text" class="form-control form-control-sm"
                                   [value]="rapidFieldFilter()"
                                   (input)="onRapidFieldInput($event)"
                                   (keydown)="onRapidFieldKeydown($event)"
                                   (focus)="rapidFieldOpen.set(true)"
                                   (blur)="rapidFieldBlur()"
                                   placeholder="Type to filter fields..." />
                            @if (rapidFieldOpen() && rapidFieldsFiltered().length > 0) {
                                <div class="rapid-dropdown">
                                    @for (f of rapidFieldsFiltered(); track f.fieldId; let i = $index) {
                                        <div class="rapid-dropdown-item"
                                             [class.active]="i === rapidFieldIndex()"
                                             (mousedown)="selectRapidField(f)">
                                            {{ f.fName }}
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Time typeahead -->
                    <div class="rapid-time mb-2">
                        <label class="form-label form-label-sm mb-1">Time</label>
                        <div class="rapid-typeahead">
                            <input type="text" class="form-control form-control-sm"
                                   [value]="rapidTimeFilter()"
                                   (input)="onRapidTimeInput($event)"
                                   (keydown)="onRapidTimeKeydown($event)"
                                   (focus)="rapidTimeOpen.set(true)"
                                   (blur)="rapidTimeBlur()"
                                   [disabled]="!rapidSelectedField()"
                                   placeholder="Type to filter times..." />
                            @if (rapidTimeOpen() && rapidTimesFiltered().length > 0) {
                                <div class="rapid-dropdown">
                                    @for (s of rapidTimesFiltered(); track s.gDate; let i = $index) {
                                        <div class="rapid-dropdown-item"
                                             [class.active]="i === rapidTimeIndex()"
                                             (mousedown)="selectRapidTime(s)">
                                            {{ s.label }}
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-outline-secondary" (click)="closeRapidModal()">Close</button>
                <button class="btn btn-sm btn-primary"
                        [disabled]="!rapidSelectedField() || !rapidSelectedTime() || isPlacing()"
                        (click)="rapidPlaceGame()">
                    @if (isPlacing()) {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    {{ remainingPairingsCount() > 1 ? 'Place & Next' : 'Place & Done' }}
                </button>
            </div>
        </div>
    </tsic-dialog>
}

<div class="schedule-div-container">

    <!-- ── Header ── -->
    <div class="schedule-header">
        <h5 class="mb-0">Schedule by Division</h5>
    </div>

    <!-- ── Main layout: Navigator+Pairings (left) | Schedule Grid (right) ── -->
    <div class="schedule-layout">

        <!-- ══════════ LEFT PANEL: Navigator + Pairings ══════════ -->
        <div class="left-panel">

            <!-- ── Division Navigator ── -->
            <div class="nav-panel">
                <div class="panel-header d-flex align-items-center justify-content-between">
                    <span class="fw-semibold">Agegroup/Divisions</span>
                    @if (expandedAgegroups().size > 0) {
                        <button class="collapse-all-btn" (click)="collapseAll()" title="Collapse all">
                            <i class="bi bi-chevron-bar-contract"></i>
                        </button>
                    }
                </div>
                <div class="panel-body">
                    @if (isNavLoading()) {
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary"></div>
                        </div>
                    } @else {
                        <div class="nav-tree">
                            @for (ag of agegroups(); track ag.agegroupId) {
                                <div class="nav-agegroup">
                                    <div class="nav-agegroup-header"
                                         (click)="toggleAgegroup(ag.agegroupId)"
                                         [class.expanded]="isExpanded(ag.agegroupId)">
                                        <i class="bi" [class.bi-chevron-right]="!isExpanded(ag.agegroupId)"
                                           [class.bi-chevron-down]="isExpanded(ag.agegroupId)"></i>
                                        @if (ag.color) {
                                            <span class="color-dot" [style.background]="ag.color"></span>
                                        }
                                        <span class="nav-ag-name">{{ ag.agegroupName }}</span>
                                        <span class="badge rounded-pill ms-auto ag-badge"
                                              [style.background]="ag.color ?? 'var(--bs-secondary-bg)'"
                                              [style.color]="contrastText(ag.color)">
                                            {{ agTeamCount(ag) }}
                                        </span>
                                    </div>

                                    @if (isExpanded(ag.agegroupId)) {
                                        <div class="nav-divisions">
                                            @for (div of ag.divisions; track div.divId) {
                                                <div class="nav-division"
                                                     [class.active]="selectedDivision()?.divId === div.divId"
                                                     (click)="selectDivision(div, ag.agegroupId)">
                                                    <span class="div-name">{{ div.divName }}</span>
                                                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">
                                                        {{ div.teamCount }}
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- ── Pairings Panel (below navigator) ── -->
            @if (selectedDivision()) {
                <div class="pairings-panel">
                    <div class="panel-header d-flex align-items-center justify-content-between">
                        <span class="fw-semibold">Pairings</span>
                        @if (selectedPairing()) {
                            <span class="badge bg-success-subtle text-success-emphasis">
                                <i class="bi bi-cursor-fill me-1"></i>Click open slot to place
                            </span>
                        }
                    </div>

                    @if (isPairingsLoading()) {
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary"></div>
                        </div>
                    } @else {
                        <div class="panel-body pairings-body">
                            @for (p of pairings(); track p.ai) {
                                <div class="pairing-row"
                                     [class.pairing-selected]="isPairingSelected(p)"
                                     [class.pairing-scheduled]="!p.bAvailable"
                                     (click)="p.bAvailable ? selectPairingForPlacement(p) : null">
                                    <span class="pairing-gno">G{{ p.gameNumber }}</span>
                                    <span class="pairing-teams">{{ teamDes(p.t1Type, p.t1) }} vs {{ teamDes(p.t2Type, p.t2) }}</span>
                                    <span class="pairing-rnd">R{{ p.rnd }}</span>
                                    @if (p.bAvailable) {
                                        <button class="pairing-pick-btn" title="Select for placement"
                                                (click)="selectPairingForPlacement(p); $event.stopPropagation()">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                    } @else {
                                        <i class="bi bi-check-circle-fill pairing-scheduled-icon"></i>
                                    }
                                </div>
                            }

                            @if (pairings().length === 0) {
                                <div class="empty-state-sm">
                                    <p class="text-secondary mb-0">No pairings for this division</p>
                                </div>
                            }
                        </div>
                    }

                    <!-- Teams toggle -->
                    @if (divisionTeams().length > 0) {
                        <div class="section-label-toggle" (click)="toggleTeams()">
                            <i class="bi me-1"
                               [class.bi-chevron-down]="showTeams()"
                               [class.bi-chevron-right]="!showTeams()"></i>
                            Teams ({{ divisionTeams().length }})
                        </div>
                        @if (showTeams()) {
                            <div class="teams-list">
                                @for (team of divisionTeams(); track team.teamId) {
                                    <div class="team-row">
                                        <span class="team-rank">{{ team.divRank }}</span>
                                        <span class="team-name">{{ team.teamName }}</span>
                                        <span class="team-club text-secondary">{{ team.clubName }}</span>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            }
        </div>

        <!-- ══════════ RIGHT PANEL: Schedule Grid ══════════ -->
        <div class="grid-panel">
            @if (!selectedDivision()) {
                <div class="empty-state">
                    <i class="bi bi-calendar3 text-secondary icon-lg"></i>
                    <p class="text-secondary mt-2 mb-0">Select a division to view the schedule grid</p>
                </div>
            } @else {
                <!-- Grid Header -->
                <div class="grid-header">
                    <span class="fw-semibold">{{ selectedDivision()!.divName }}</span>
                    <span class="badge bg-primary-subtle text-primary-emphasis">
                        {{ teamCount() }} teams
                    </span>
                    @if (selectedGame()) {
                        <span class="badge bg-info-subtle text-info-emphasis">
                            <i class="bi bi-arrows-move me-1"></i>Click destination to move
                        </span>
                    }
                    @if (breakingConflictCount() > 0) {
                        <span class="badge bg-danger-subtle text-danger-emphasis" title="Slot collisions or same-team double-bookings">
                            <i class="bi bi-exclamation-octagon-fill me-1"></i>{{ breakingConflictCount() }} breaking
                        </span>
                    }
                    @if (backToBackGameIds().size > 0) {
                        <span class="badge bg-warning-subtle text-warning-emphasis" title="Teams playing consecutive timeslots">
                            <i class="bi bi-clock-history me-1"></i>{{ backToBackGameIds().size }} back-to-back
                        </span>
                    }
                    <div class="ms-auto d-flex gap-1">
                        <!-- Delete all division games -->
                        <button class="btn btn-sm btn-outline-danger"
                                (click)="confirmDeleteDivGames()"
                                [disabled]="isDeletingDivGames()"
                                title="Delete all games for this division">
                            @if (isDeletingDivGames()) {
                                <span class="spinner-border spinner-border-sm"></span>
                            } @else {
                                <i class="bi bi-trash"></i>
                            }
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Delete confirmation -->
                @if (showDeleteDivConfirm()) {
                    <div class="alert alert-danger m-2 mb-0 py-1 px-2 d-flex align-items-center justify-content-between">
                        <span>
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Delete <strong>all</strong> scheduled games for <strong>{{ selectedDivision()!.divName }}</strong>?
                        </span>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-danger" (click)="deleteDivGames()">Yes, Delete All</button>
                            <button class="btn btn-sm btn-outline-secondary" (click)="cancelDeleteDivGames()">Cancel</button>
                        </div>
                    </div>
                }

                <!-- Grid Content -->
                @if (isGridLoading()) {
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                } @else if (gridColumns().length === 0) {
                    <div class="empty-state">
                        <i class="bi bi-exclamation-circle text-secondary icon-lg"></i>
                        <p class="text-secondary mt-2 mb-0">No fields or timeslots configured for this division</p>
                    </div>
                } @else {
                    <div class="grid-scroll">
                        <table class="schedule-grid">
                            <thead>
                                <tr>
                                    <th class="col-time sticky-col">Time</th>
                                    @for (col of gridColumns(); track col.fieldId) {
                                        <th class="col-field">{{ col.fName }}</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @for (row of gridRows(); track row.gDate) {
                                    <tr>
                                        <td class="col-time sticky-col">
                                            <div class="time-label">{{ formatDate(row.gDate) }}</div>
                                            <div class="time-sub">{{ formatTimeOnly(row.gDate) }}</div>
                                        </td>
                                        @for (cell of row.cells; track $index; let ci = $index) {
                                            <td class="col-field"
                                                [class.cell-open]="!cell && (selectedPairing() || selectedGame())"
                                                [class.cell-game]="!!cell"
                                                [class.cell-selected-game]="cell && isGameSelected(cell)"
                                                [class.cell-move-target]="selectedGame() && cell && !isGameSelected(cell!)"
                                                [class.cell-breaking]="cell && isBreaking(cell)"
                                                [class.cell-back-to-back]="cell && !isBreaking(cell) && isBackToBack(cell)"
                                                [class.cell-other-div]="cell && isOtherDivision(cell)"
                                                (click)="onGridCellClick(row, ci)">
                                                @if (cell) {
                                                    <div class="game-card"
                                                         [class.game-card-current]="!isOtherDivision(cell)"
                                                         [class.game-card-other]="isOtherDivision(cell)"
                                                         [class.game-card-breaking]="isBreaking(cell)"
                                                         [class.game-card-back-to-back]="!isBreaking(cell) && isBackToBack(cell)"
                                                         [style.border-left-color]="cell.color || 'var(--bs-primary)'"
                                                         [style.background]="isOtherDivision(cell) ? null : agBg(cell.color)">
                                                        <div class="game-row1">
                                                            <span class="game-matchup">{{ teamDes(cell.t1Type, cell.t1No) }}v{{ teamDes(cell.t2Type, cell.t2No) }}</span>
                                                            <span class="game-label">{{ cell.agDivLabel }}</span>
                                                            <span class="game-gid">G{{ cell.gid }}</span>
                                                        </div>
                                                        <div class="game-team"><span class="game-team-des">({{ teamDes(cell.t1Type, cell.t1No) }})</span> {{ cell.t1Label }}</div>
                                                        <div class="game-team"><span class="game-team-des">({{ teamDes(cell.t2Type, cell.t2No) }})</span> {{ cell.t2Label }}</div>
                                                        <!-- Conflict icons -->
                                                        <div class="game-icons">
                                                            @if (isSlotCollision(cell)) {
                                                                <i class="bi bi-layers-fill conflict-icon conflict-breaking" title="Multiple games in this slot"></i>
                                                            }
                                                            @if (isTimeClash(cell)) {
                                                                <i class="bi bi-people-fill conflict-icon conflict-breaking" title="Team double-booked at this time"></i>
                                                            }
                                                            @if (!isBreaking(cell) && isBackToBack(cell)) {
                                                                <i class="bi bi-clock-history conflict-icon conflict-b2b" title="Team playing back-to-back slots"></i>
                                                            }
                                                        </div>
                                                        <!-- Action buttons -->
                                                        <div class="game-actions">
                                                            @if (!isOtherDivision(cell)) {
                                                                <button class="game-action-btn game-move-btn"
                                                                        (click)="selectGameForMove(cell, row, ci); $event.stopPropagation()"
                                                                        title="Move this game">
                                                                    <i class="bi bi-arrows-move"></i>
                                                                </button>
                                                            }
                                                            @if (!isOtherDivision(cell)) {
                                                                <button class="game-action-btn game-delete-btn"
                                                                        (click)="deleteGame(cell, row, ci); $event.stopPropagation()"
                                                                        title="Remove game">
                                                                    <i class="bi bi-x"></i>
                                                                </button>
                                                            }
                                                        </div>
                                                        <!-- Move mode: swap indicator on other-div games -->
                                                        @if (selectedGame() && !isGameSelected(cell)) {
                                                            <div class="swap-hint">
                                                                <i class="bi bi-arrow-down-up"></i>
                                                            </div>
                                                        }
                                                    </div>
                                                } @else if (selectedPairing()) {
                                                    <div class="open-slot-hint">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </div>
                                                } @else if (selectedGame()) {
                                                    <div class="open-slot-hint move-slot-hint">
                                                        <i class="bi bi-arrow-down"></i>
                                                    </div>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    </div>
</div>

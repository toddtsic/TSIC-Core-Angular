<!-- Error banner -->
@if (errorMessage()) {
  <div class="alert alert-danger d-flex align-items-center mx-3 mt-3" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ errorMessage() }}
    <button type="button" class="btn-close ms-auto" (click)="errorMessage.set(null)"></button>
  </div>
}

<!-- Mobile breadcrumb bar (< 768px) -->
<div class="mobile-breadcrumb d-md-none">
  <button class="btn btn-sm btn-outline-secondary" (click)="toggleDrawer()">
    <i class="bi bi-list me-1"></i>Tree
  </button>
  @if (selectedNode()) {
    <span class="breadcrumb-label">
      <i class="bi {{ getLevelIcon(selectedLevel()) }} me-1"></i>
      {{ selectedNode()!.name }}
    </span>
  }
</div>

<!-- Main layout -->
<div class="ladt-layout">
  <!-- Backdrop for mobile drawer -->
  @if (drawerOpen()) {
    <div class="drawer-backdrop d-md-none" (click)="drawerOpen.set(false)"></div>
  }

  <!-- Tree panel (left) -->
  <aside class="tree-panel" [class.drawer-open]="drawerOpen()">
    <div class="tree-header">
      <h6 class="mb-0">LADT Hierarchy</h6>
      <div class="tree-stats">
        <span class="badge bg-primary-subtle text-primary-emphasis">{{ totalTeams() }} teams</span>
        <span class="badge bg-success-subtle text-success-emphasis">{{ totalPlayers() }} players</span>
      </div>
      <div class="tree-kpis">
        <span class="kpi-badge kpi-waitlisted">
          <span class="kpi-dot"></span>
          Active Waitlisted Teams
          <span class="kpi-count">{{ teamStatusKpis().waitlisted }}</span>
        </span>
        <span class="kpi-badge kpi-active">
          <span class="kpi-dot"></span>
          Active Non Waitlisted Teams
          <span class="kpi-count">{{ teamStatusKpis().nonWaitlisted }}</span>
        </span>
        <span class="kpi-badge kpi-scheduled">
          <span class="kpi-dot"></span>
          Active Scheduled Teams
          <span class="kpi-count">{{ teamStatusKpis().scheduled }}</span>
        </span>
      </div>
    </div>

    <div class="tree-toolbar">
      <button class="btn btn-sm btn-outline-secondary" (click)="expandAll()" title="Expand all">
        <i class="bi bi-arrows-expand"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" (click)="collapseAll()" title="Collapse all">
        <i class="bi bi-arrows-collapse"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary ms-auto" (click)="loadTree()" title="Refresh"
              [disabled]="isLoading()">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <div class="dropdown" style="position: relative;">
        <button class="btn btn-sm btn-outline-primary dropdown-toggle" (click)="actionsOpen.set(!actionsOpen())">
          <i class="bi bi-gear"></i>
        </button>
        @if (actionsOpen()) {
          <ul class="dropdown-menu dropdown-menu-end show">
            <li><button class="dropdown-item" (click)="addWaitlistAgegroups(); actionsOpen.set(false)">
              <i class="bi bi-collection me-2"></i>Add WAITLIST Age Groups
            </button></li>
          </ul>
        }
      </div>
    </div>

    @if (isLoading()) {
      <div class="text-center py-4">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    } @else if (flatNodes().length === 0) {
      <div class="text-center py-4 text-body-secondary">
        <i class="bi bi-folder2-open fs-3 d-block mb-2"></i>
        No leagues found for this job.
      </div>
    } @else {
      <div class="tree-scroll">
        <cdk-tree [dataSource]="visibleNodes()" [levelAccessor]="levelAccessor" [trackBy]="trackById">
          <cdk-tree-node *cdkTreeNodeDef="let node" class="tree-node"
                         [class.selected]="selectedNode()?.id === node.id"
                         [class.inactive]="!node.active"
                         [class.has-club]="node.clubName"
                         [class.special]="node.isSpecial"
                         [class.phantom]="node.isPhantom"
                         [style.padding-left.px]="node.level * 20 + 8">
            @if (node.isPhantom) {
              <span class="tree-toggle-spacer"></span>
              <i class="bi {{ getLevelIcon(node.level) }} tree-icon level-{{ node.level }}"></i>
              <input
                #phantomInput
                class="form-control form-control-sm phantom-input"
                type="text"
                [placeholder]="'New ' + getLevelLabel(node.level) + '...'"
                (keydown.enter)="commitPhantom(phantomInput.value); $event.preventDefault()"
                (keydown.escape)="cancelPhantom(); $event.preventDefault()"
                (blur)="cancelPhantom()"
              />
            } @else {
              <span class="tree-toggle-spacer"></span>
              <button class="tree-node-btn" (click)="selectNode(node)"
                      [title]="node.clubName ? node.clubName + ' \u2014 ' + node.name : node.name">
                <i class="bi {{ getLevelIcon(node.level) }} tree-icon level-{{ node.level }}"></i>
                @if (node.level === 3 && node.clubName) {
                  <span class="tree-label-group">
                    <span class="tree-label-primary">{{ node.clubName }}</span>
                    <span class="tree-label-secondary">{{ node.name }}</span>
                  </span>
                } @else {
                  @if (node.level === 1 && node.color) {
                    <span class="tree-color-dot" [style.background]="node.color"></span>
                  }
                  <span class="tree-label">{{ node.name }}</span>
                }
                <span class="node-badges ms-auto">
                  @if (!node.active) {
                    <span class="badge bg-danger-subtle text-danger-emphasis">Inactive</span>
                  }
                  @if (node.level < 3) {
                    <span class="badge bg-primary-subtle text-primary-emphasis">{{ node.teamCount }}</span>
                  }
                  <span class="badge bg-success-subtle text-success-emphasis">{{ node.playerCount }}</span>
                </span>
              </button>
              <!-- Delete button for leaf nodes (levels 1+, except Unassigned divisions) -->
              @if (canDelete(node)) {
                <button class="btn-remove-node" [title]="'Delete ' + getLevelLabel(node.level)"
                        (click)="confirmDelete(node); $event.stopPropagation()">
                  <i class="bi bi-dash-circle"></i>
                </button>
              }
              <!-- Add child button for leaf nodes at levels 0-2 -->
              @if (node.level === 2) {
                <button class="btn-add-child" title="Add Team" (click)="startAdd(node.id); $event.stopPropagation()">
                  <i class="bi bi-plus-circle"></i>
                </button>
              }
            }
          </cdk-tree-node>

          <cdk-tree-node *cdkTreeNodeDef="let node; when: hasChild" class="tree-node"
                         [class.selected]="selectedNode()?.id === node.id"
                         [class.inactive]="!node.active"
                         [class.has-club]="node.clubName"
                         [class.special]="node.isSpecial"
                         [style.padding-left.px]="node.level * 20 + 8">
            <button class="tree-toggle" (click)="toggleNode(node)">
              <i class="bi" [class.bi-chevron-right]="!isNodeExpanded(node)"
                 [class.bi-chevron-down]="isNodeExpanded(node)"></i>
            </button>
            <button class="tree-node-btn" (click)="selectNode(node)"
                    [title]="node.clubName ? node.clubName + ' \u2014 ' + node.name : node.name">
              <i class="bi {{ getLevelIcon(node.level) }} tree-icon level-{{ node.level }}"></i>
              @if (node.level === 3 && node.clubName) {
                <span class="tree-label-group">
                  <span class="tree-label-primary">{{ node.clubName }}</span>
                  <span class="tree-label-secondary">{{ node.name }}</span>
                </span>
              } @else {
                @if (node.level === 1 && node.color) {
                  <span class="tree-color-dot" [style.background]="node.color"></span>
                }
                <span class="tree-label">{{ node.name }}</span>
              }
              <span class="node-badges ms-auto">
                @if (!node.active) {
                  <span class="badge bg-danger-subtle text-danger-emphasis">Inactive</span>
                }
                @if (node.level < 3) {
                  <span class="badge bg-primary-subtle text-primary-emphasis">{{ node.teamCount }}</span>
                }
                <span class="badge bg-success-subtle text-success-emphasis">{{ node.playerCount }}</span>
              </span>
            </button>
            <!-- Delete button (levels 1+, except Unassigned divisions) -->
            @if (canDelete(node)) {
              <button class="btn-remove-node" [title]="'Delete ' + getLevelLabel(node.level)"
                      (click)="confirmDelete(node); $event.stopPropagation()">
                <i class="bi bi-dash-circle"></i>
              </button>
            }
            <!-- Add child buttons by level -->
            @if (node.level === 0) {
              <button class="btn-add-child" title="Add Age Group" (click)="startAdd(node.id); $event.stopPropagation()">
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            @if (node.level === 1) {
              <button class="btn-add-child" title="Add Division" (click)="startAdd(node.id); $event.stopPropagation()">
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            @if (node.level === 2) {
              <button class="btn-add-child" title="Add Team" (click)="startAdd(node.id); $event.stopPropagation()">
                <i class="bi bi-plus-circle"></i>
              </button>
            }
          </cdk-tree-node>
        </cdk-tree>
      </div>
    }
  </aside>

  <!-- Detail panel (right) -->
  <main class="detail-panel">
    @if (!selectedNode()) {
      <div class="empty-detail">
        <i class="bi bi-hand-index fs-1 text-body-secondary"></i>
        <p class="mt-3 text-body-secondary">Select an item from the tree to view its details.</p>
      </div>
    } @else {
      <!-- Sibling comparison grid -->
      <div class="sibling-grid-container">
        @if (isSiblingsLoading()) {
          <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          </div>
        } @else {
          <app-ladt-sibling-grid
            [columns]="siblingColumns()"
            [data]="siblingData()"
            [selectedId]="selectedNode()!.id"
            [idField]="siblingIdField()"
            [levelLabel]="siblingLevelLabel()"
            [levelIcon]="siblingLevelIcon()"
            [parentParts]="siblingParentParts()"
            (rowSelected)="onGridRowSelected($event)"
          />
        }
      </div>

      <!-- Detail form for selected entity -->
      <div class="detail-form-container">
        @if (selectedLevel() === 0) {
          <app-league-detail
            [leagueId]="selectedNode()!.id"
            (saved)="onDetailSaved()"
          />
        } @else if (selectedLevel() === 1) {
          <app-agegroup-detail
            [agegroupId]="selectedNode()!.id"
            [canDelete]="canDelete(selectedNode()!)"
            [playerCount]="selectedNode()!.playerCount"
            (saved)="onDetailSaved()"
            (deleted)="onDetailDeleted()"
          />
        } @else if (selectedLevel() === 2) {
          <app-division-detail
            [divisionId]="selectedNode()!.id"
            [siblingNames]="siblingDivisionNames()"
            [canDelete]="canDelete(selectedNode()!)"
            (saved)="onDetailSaved()"
            (deleted)="onDetailDeleted()"
          />
        } @else if (selectedLevel() === 3) {
          <app-team-detail
            [teamId]="selectedNode()!.id"
            (saved)="onDetailSaved()"
            (cloned)="onDetailSaved()"
            (clubChanged)="onDetailSaved()"
          />
        }
      </div>
    }
  </main>
</div>

<!-- Delete / Drop confirmation dialog -->
@if (showDeleteConfirm()) {
  <confirm-dialog
    [title]="deleteDialogTitle()"
    [message]="deleteDialogMessage()"
    [confirmLabel]="deleteDialogConfirmLabel()"
    confirmVariant="danger"
    (confirmed)="onDeleteConfirmed()"
    (cancelled)="onDeleteCancelled()"
  />
}

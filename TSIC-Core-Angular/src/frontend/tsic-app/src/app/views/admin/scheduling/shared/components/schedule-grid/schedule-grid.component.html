<!-- Grid Header Bar -->
<div class="grid-header">
    <ng-content select="[gridTitle]" />

    @if (selectedGameGid()) {
        <span class="badge bg-info-subtle text-info-emphasis">
            <i class="bi bi-arrows-move me-1"></i>Click destination to move
        </span>
    }
    @if (breakingConflictCount() > 0) {
        <span class="badge bg-danger-subtle text-danger-emphasis" title="Slot collisions or same-team double-bookings">
            <i class="bi bi-exclamation-octagon-fill me-1"></i>{{ breakingConflictCount() }} breaking
        </span>
    }
    @if (backToBackGameIds().size > 0) {
        <span class="badge bg-warning-subtle text-warning-emphasis" title="Teams playing consecutive timeslots">
            <i class="bi bi-clock-history me-1"></i>{{ backToBackGameIds().size }} back-to-back
        </span>
    }
    @if (gridDays().length > 1) {
        <div class="day-jumps">
            @for (day of gridDays(); track day.rowIndex) {
                <button class="day-jump-btn" (click)="scrollToRow(day.rowIndex)">
                    {{ day.label }}
                </button>
            }
        </div>
    }

    <div class="ms-auto d-flex gap-1">
        <ng-content select="[gridActions]" />
    </div>
</div>

<!-- Extra content below header (delete confirmations, add-timeslot, etc.) -->
<ng-content select="[gridExtra]" />

<!-- Grid Content -->
@if (isLoading()) {
    <div class="text-center p-4">
        <div class="spinner-border text-primary"></div>
    </div>
} @else if (gridColumns().length === 0) {
    <div class="empty-state">
        <i class="bi bi-exclamation-circle text-secondary icon-lg"></i>
        <p class="text-secondary mt-2 mb-0">{{ emptyMessage() }}</p>
    </div>
} @else {
    <div class="grid-scroll" #gridScroll>
        <table class="schedule-grid">
            <thead>
                <tr>
                    <th class="col-time sticky-col">Time</th>
                    @for (col of gridColumns(); track col.fieldId) {
                        <th class="col-field">{{ col.fName }}</th>
                    }
                </tr>
            </thead>
            <tbody>
                @for (row of gridRows(); track row.gDate) {
                    <tr>
                        <td class="col-time sticky-col">
                            <div class="time-label">{{ formatDate(row.gDate) }}</div>
                            <div class="time-sub">{{ formatTimeOnly(row.gDate) }}</div>
                        </td>
                        @for (cell of row.cells; track $index; let ci = $index) {
                            <td class="col-field"
                                [class.cell-open]="!cell && showOpenSlotHints()"
                                [class.cell-game]="!!cell"
                                [class.cell-selected-game]="cell && isGameSelected(cell)"
                                [class.cell-move-target]="(showMoveSlotHints() || selectedGameGid()) && (!cell || (cell && !isGameSelected(cell!)))"
                                [class.cell-breaking]="cell && isBreaking(cell)"
                                [class.cell-back-to-back]="cell && !isBreaking(cell) && isBackToBack(cell)"
                                [class.cell-other-div]="cell && isOtherDivision(cell)"
                                (click)="onCellClick(row, ci)">
                                @if (cell) {
                                    <app-game-card
                                        [game]="cell"
                                        [showMatchupCodes]="showMatchupCodes()"
                                        [showGameId]="showGameId()"
                                        [showTeamDesignators]="showTeamDesignators()"
                                        [showActions]="showActionButtons() && !isOtherDivision(cell)"
                                        [isSelected]="isGameSelected(cell)"
                                        [isOtherDivision]="isOtherDivision(cell)"
                                        [showSwapHint]="!!selectedGameGid() && !isGameSelected(cell)"
                                        [conflictIcons]="{
                                            slotCollision: isSlotCollision(cell),
                                            timeClash: isTimeClash(cell),
                                            backToBack: isBackToBack(cell)
                                        }"
                                        (moveClicked)="gameMoveRequested.emit({ game: cell, row: row, colIndex: ci })"
                                        (deleteClicked)="gameDeleteRequested.emit({ game: cell, row: row, colIndex: ci })" />
                                } @else if (showOpenSlotHints()) {
                                    <div class="open-slot-hint">
                                        <i class="bi bi-plus-circle"></i>
                                    </div>
                                } @else if (showMoveSlotHints() || selectedGameGid()) {
                                    <div class="open-slot-hint move-slot-hint">
                                        <i class="bi bi-arrow-down"></i>
                                    </div>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="rescheduler-container">

    <!-- ── Header ── -->
    <div class="rescheduler-header">
        <h5 class="mb-0">Rescheduler</h5>
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-warning" (click)="openWeatherModal()">
                <i class="bi bi-cloud-rain me-1"></i>Weather Adjust
            </button>
            <button class="btn btn-sm btn-outline-primary" (click)="openEmailModal()">
                <i class="bi bi-envelope me-1"></i>Email Participants
            </button>
        </div>
    </div>

    <!-- ── Main layout: Filters (left) | Grid (right) ── -->
    <div class="rescheduler-layout">

        <!-- ══════════ LEFT PANEL: Filters ══════════ -->
        <div class="left-panel">
            <div class="filter-panel">
                <div class="panel-header d-flex align-items-center justify-content-between">
                    <span class="fw-semibold">Filters</span>
                    @if (hasActiveFilters()) {
                        <button class="btn btn-sm btn-link p-0" (click)="clearFilters()">Clear</button>
                    }
                </div>

                <div class="panel-body">
                    @if (isFiltersLoading()) {
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary"></div>
                        </div>
                    } @else {

                        <!-- CADT Tree -->
                        <div class="filter-section">
                            <div class="filter-section-label">Clubs / Agegroups / Divisions / Teams</div>
                            <app-cadt-tree-filter
                                [treeData]="clubs()"
                                [checkedIds]="cadtCheckedIds()"
                                (checkedIdsChange)="onCadtSelectionChange($event)" />
                        </div>

                        <!-- Game Days -->
                        @if (gameDays().length > 0) {
                            <div class="filter-section">
                                <div class="filter-section-label">Game Days</div>
                                <div class="filter-chips">
                                    @for (day of gameDays(); track day) {
                                        <button class="chip"
                                                [class.chip-selected]="isGameDaySelected(day)"
                                                (click)="toggleGameDayFilter(day)">
                                            {{ formatGameDay(day) }}
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Fields -->
                        @if (fields().length > 0) {
                            <div class="filter-section">
                                <div class="filter-section-label">Fields</div>
                                <div class="filter-list">
                                    @for (field of fields(); track field.fieldId) {
                                        <label class="filter-item">
                                            <input type="checkbox" class="form-check-input"
                                                   [checked]="isFieldSelected(field.fieldId)"
                                                   (change)="toggleFieldFilter(field.fieldId)">
                                            <span>{{ field.fName }}</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Apply filters -->
                <div class="panel-footer">
                    <button class="btn btn-sm btn-primary w-100" (click)="loadGrid()">
                        <i class="bi bi-funnel me-1"></i>Load Grid
                    </button>
                </div>
            </div>
        </div>

        <!-- ══════════ RIGHT PANEL: Schedule Grid ══════════ -->
        <div class="grid-panel">
            @if (!gridResponse()) {
                <div class="empty-state">
                    <i class="bi bi-calendar3 text-secondary icon-lg"></i>
                    <p class="text-secondary mt-2 mb-0">Apply filters and click "Load Grid" to view the schedule</p>
                </div>
            } @else {
                <app-schedule-grid #scheduleGrid
                    [gridResponse]="gridResponse()"
                    [isLoading]="isGridLoading()"
                    [emptyMessage]="'No games match the selected filters'"
                    [selectedGameGid]="selectedGame()?.gid ?? null"
                    [showMoveSlotHints]="!!selectedGame()"
                    (cellClicked)="onGridCellClick($event)">

                    <!-- Projected into grid header title area -->
                    <span gridTitle class="fw-semibold">Cross-Division Schedule</span>

                    <!-- Projected into grid header actions area -->
                    <button gridActions class="btn btn-sm btn-outline-secondary" (click)="toggleAddTimeslot()">
                        <i class="bi bi-plus-circle me-1"></i>Add Row
                    </button>

                    <!-- Projected below grid header -->
                    @if (showAddTimeslot()) {
                        <div gridExtra class="add-timeslot-bar">
                            <label class="form-label mb-0">Date</label>
                            <input type="date" class="form-control form-control-sm"
                                   [ngModel]="newTimeslotDate()"
                                   (ngModelChange)="newTimeslotDate.set($event)">
                            <label class="form-label mb-0">Time</label>
                            <input type="time" class="form-control form-control-sm"
                                   [ngModel]="newTimeslotTime()"
                                   (ngModelChange)="newTimeslotTime.set($event)">
                            <button class="btn btn-sm btn-primary" (click)="addTimeslotAndReload()">
                                <i class="bi bi-plus"></i> Inject Row
                            </button>
                        </div>
                    }
                </app-schedule-grid>
            }
        </div>
    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════ -->
<!-- Weather Adjustment Modal -->
<!-- ══════════════════════════════════════════════════════════════ -->
@if (showWeatherModal()) {
    <div class="modal-backdrop" (click)="closeWeatherModal()"></div>
    <div class="modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title mb-0">
                    <i class="bi bi-cloud-rain me-1"></i>Weather / Time Adjustment
                </h6>
                <button class="btn-close" (click)="closeWeatherModal()"></button>
            </div>
            <div class="modal-body">
                <p class="text-secondary mb-3">
                    Compress or expand game start times for a specific date and set of fields.
                </p>

                <!-- Before -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Current (Before)</label>
                    <div class="d-flex gap-2">
                        <div class="flex-fill">
                            <label class="form-label">First Game Time</label>
                            <input type="datetime-local" class="form-control form-control-sm"
                                   [ngModel]="weatherPreFirstGame()"
                                   (ngModelChange)="weatherPreFirstGame.set($event)">
                        </div>
                        <div style="width:100px">
                            <label class="form-label">Interval (min)</label>
                            <input type="number" class="form-control form-control-sm"
                                   [ngModel]="weatherPreGSI()"
                                   (ngModelChange)="weatherPreGSI.set($event)">
                        </div>
                    </div>
                </div>

                <!-- After -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Desired (After)</label>
                    <div class="d-flex gap-2">
                        <div class="flex-fill">
                            <label class="form-label">New First Game Time</label>
                            <input type="datetime-local" class="form-control form-control-sm"
                                   [ngModel]="weatherPostFirstGame()"
                                   (ngModelChange)="weatherPostFirstGame.set($event)">
                        </div>
                        <div style="width:100px">
                            <label class="form-label">Interval (min)</label>
                            <input type="number" class="form-control form-control-sm"
                                   [ngModel]="weatherPostGSI()"
                                   (ngModelChange)="weatherPostGSI.set($event)">
                        </div>
                    </div>
                </div>

                <!-- Fields -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Fields</label>
                    <div class="filter-list">
                        @for (field of fields(); track field.fieldId) {
                            <label class="filter-item">
                                <input type="checkbox" class="form-check-input"
                                       [checked]="isWeatherFieldSelected(field.fieldId)"
                                       (change)="toggleWeatherField(field.fieldId)">
                                <span>{{ field.fName }}</span>
                            </label>
                        }
                    </div>
                </div>

                <!-- Preview -->
                <div class="d-flex align-items-center gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-secondary" (click)="previewWeatherAffected()"
                            [disabled]="isWeatherLoading()">
                        Preview
                    </button>
                    @if (weatherAffectedCount() !== null) {
                        <span class="badge bg-secondary-subtle text-secondary-emphasis">
                            {{ weatherAffectedCount() }} games affected
                        </span>
                    }
                </div>

                <!-- Result -->
                @if (weatherResult()) {
                    <div class="alert mb-0 py-2"
                         [class.alert-success]="weatherResult()!.success"
                         [class.alert-danger]="!weatherResult()!.success">
                        {{ weatherResult()!.message }}
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-secondary" (click)="closeWeatherModal()">Close</button>
                <button class="btn btn-sm btn-warning" (click)="executeWeatherAdjust()"
                        [disabled]="isWeatherLoading() || !weatherPreFirstGame() || !weatherPostFirstGame()">
                    @if (isWeatherLoading()) {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Apply Adjustment
                </button>
            </div>
        </div>
    </div>
}

<!-- ══════════════════════════════════════════════════════════════ -->
<!-- Email Modal -->
<!-- ══════════════════════════════════════════════════════════════ -->
@if (showEmailModal()) {
    <div class="modal-backdrop" (click)="closeEmailModal()"></div>
    <div class="modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title mb-0">
                    <i class="bi bi-envelope me-1"></i>Email Game Participants
                </h6>
                <button class="btn-close" (click)="closeEmailModal()"></button>
            </div>
            <div class="modal-body">
                @if (emailSent()) {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-1"></i>
                        Email sent to <strong>{{ emailSentCount() }}</strong> recipients.
                        @if (emailFailedCount() > 0) {
                            <span class="text-danger ms-2">{{ emailFailedCount() }} failed.</span>
                        }
                    </div>
                } @else {
                    <!-- Date Range -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Game Date Range</label>
                        <div class="d-flex gap-2">
                            <div class="flex-fill">
                                <label class="form-label">From</label>
                                <input type="datetime-local" class="form-control form-control-sm"
                                       [ngModel]="emailFirstGame()"
                                       (ngModelChange)="emailFirstGame.set($event)">
                            </div>
                            <div class="flex-fill">
                                <label class="form-label">To</label>
                                <input type="datetime-local" class="form-control form-control-sm"
                                       [ngModel]="emailLastGame()"
                                       (ngModelChange)="emailLastGame.set($event)">
                            </div>
                        </div>
                    </div>

                    <!-- Fields -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fields</label>
                        <div class="filter-list">
                            @for (field of fields(); track field.fieldId) {
                                <label class="filter-item">
                                    <input type="checkbox" class="form-check-input"
                                           [checked]="isEmailFieldSelected(field.fieldId)"
                                           (change)="toggleEmailField(field.fieldId)">
                                    <span>{{ field.fName }}</span>
                                </label>
                            }
                        </div>
                    </div>

                    <!-- Preview count -->
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-secondary" (click)="previewRecipientCount()"
                                [disabled]="isEmailLoading()">
                            Preview Recipients
                        </button>
                        @if (emailRecipientCount() !== null) {
                            <span class="badge bg-secondary-subtle text-secondary-emphasis">
                                ~{{ emailRecipientCount() }} recipients
                            </span>
                        }
                    </div>

                    <!-- Subject -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Subject</label>
                        <input type="text" class="form-control form-control-sm"
                               [ngModel]="emailSubject()"
                               (ngModelChange)="emailSubject.set($event)"
                               placeholder="Schedule change notification">
                    </div>

                    <!-- Body (RTE) -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Message Body</label>
                        <ejs-richtexteditor
                            [toolbarSettings]="rteTools"
                            [height]="200"
                            (change)="onRteChange($event)">
                        </ejs-richtexteditor>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-secondary" (click)="closeEmailModal()">Close</button>
                @if (!emailSent()) {
                    <button class="btn btn-sm btn-primary" (click)="sendEmail()"
                            [disabled]="isEmailLoading() || !emailSubject() || !emailBody()">
                        @if (isEmailLoading()) {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Send Email
                    </button>
                }
            </div>
        </div>
    </div>
}

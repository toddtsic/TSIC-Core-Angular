<div class="manage-pairings-container">

    <!-- ── Header ── -->
    <div class="pairings-header">
        <h5 class="mb-0">Manage Pairings</h5>
    </div>

    <!-- ── Main layout: Navigator + Pairing Grid ── -->
    <div class="pairings-layout">

        <!-- ── Division Navigator (left) ── -->
        <div class="nav-panel">
            <div class="panel-header">
                <span class="fw-semibold">Divisions</span>
            </div>
            <div class="panel-body">
                @if (isNavLoading()) {
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                    </div>
                } @else {
                    <div class="nav-tree">
                        @for (ag of agegroups(); track ag.agegroupId) {
                            <div class="nav-agegroup">
                                <div class="nav-agegroup-header"
                                     (click)="toggleAgegroup(ag.agegroupId)"
                                     [class.expanded]="isExpanded(ag.agegroupId)">
                                    <i class="bi" [class.bi-chevron-right]="!isExpanded(ag.agegroupId)"
                                       [class.bi-chevron-down]="isExpanded(ag.agegroupId)"></i>
                                    @if (ag.color) {
                                        <span class="color-dot" [style.background]="ag.color"></span>
                                    }
                                    <span class="nav-ag-name">{{ ag.agegroupName }}</span>
                                </div>

                                @if (isExpanded(ag.agegroupId)) {
                                    <div class="nav-divisions">
                                        @for (div of ag.divisions; track div.divId) {
                                            <div class="nav-division"
                                                 [class.active]="selectedDivision()?.divId === div.divId"
                                                 (click)="selectDivision(div)">
                                                <span class="div-name">{{ div.divName }}</span>
                                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">
                                                    {{ div.teamCount }}
                                                </span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- ── Pairing Grid (right) ── -->
        <div class="grid-panel">
            @if (!selectedDivision()) {
                <div class="empty-state">
                    <i class="bi bi-diagram-3 text-secondary icon-lg"></i>
                    <p class="text-secondary mt-2 mb-0">Select a division to view pairings</p>
                </div>
            } @else {
                <!-- Grid Header -->
                <div class="panel-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                        <span class="fw-semibold">{{ selectedDivision()!.divName }}</span>
                        <span class="badge bg-primary-subtle text-primary-emphasis ms-2">
                            {{ teamCount() }} teams
                        </span>
                    </div>
                    <div class="d-flex gap-1 flex-wrap">
                        <!-- Add Block dropdown -->
                        <div class="btn-group dropdown-anchor">
                            <button class="btn btn-sm btn-outline-primary"
                                    (click)="toggleBlockDropdown()"
                                    [disabled]="isAddingBlock() || teamCount() === 0">
                                @if (isAddingBlock()) {
                                    <span class="spinner-border spinner-border-sm"></span>
                                } @else {
                                    <i class="bi bi-plus-circle"></i>
                                }
                                Add Block
                            </button>
                            @if (showBlockDropdown()) {
                                <div class="action-popover">
                                    <div class="popover-header">
                                        <i class="bi bi-plus-circle me-1"></i>
                                        Generate Round-Robin
                                    </div>
                                    <div class="popover-body">
                                        <label class="form-label mb-1" for="blockRoundsInput">Number of rounds</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <input id="blockRoundsInput" type="number"
                                                   class="form-control form-control-sm rounds-input"
                                                   [ngModel]="blockRounds()"
                                                   (ngModelChange)="blockRounds.set($event)"
                                                   min="1" max="14">
                                            <span class="text-secondary-emphasis" style="white-space: nowrap; font-size: var(--font-size-xs)">1–14</span>
                                        </div>
                                    </div>
                                    <div class="popover-footer">
                                        <button class="btn btn-sm btn-outline-secondary" (click)="toggleBlockDropdown()">
                                            Cancel
                                        </button>
                                        <button class="btn btn-sm btn-primary" (click)="addBlock()">
                                            <i class="bi bi-play-fill me-1"></i>Generate
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Championship dropdown -->
                        <div class="btn-group dropdown-anchor">
                            <button class="btn btn-sm btn-outline-primary"
                                    (click)="toggleBracketDropdown()"
                                    [disabled]="isAddingElimination() || teamCount() === 0">
                                @if (isAddingElimination()) {
                                    <span class="spinner-border spinner-border-sm"></span>
                                } @else {
                                    <i class="bi bi-trophy"></i>
                                }
                                Championship
                            </button>
                            @if (showBracketDropdown()) {
                                <div class="action-dropdown bracket-dropdown">
                                    @for (opt of bracketOptions; track opt.key) {
                                        <button class="dropdown-item" (click)="addElimination(opt.key)">
                                            {{ opt.label }}
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Add Single -->
                        <button class="btn btn-sm btn-outline-secondary"
                                (click)="addSingle()"
                                [disabled]="isAddingSingle() || teamCount() === 0"
                                title="Add one blank pairing row">
                            @if (isAddingSingle()) {
                                <span class="spinner-border spinner-border-sm"></span>
                            } @else {
                                <i class="bi bi-plus"></i>
                            }
                        </button>

                        <!-- Who Plays Who toggle -->
                        <button class="btn btn-sm"
                                [class.btn-outline-info]="!showWhoPlaysWho()"
                                [class.btn-info]="showWhoPlaysWho()"
                                (click)="toggleWhoPlaysWho()"
                                [disabled]="teamCount() === 0"
                                title="Who Plays Who matrix">
                            <i class="bi bi-grid-3x3"></i>
                        </button>

                        <!-- Remove All -->
                        <button class="btn btn-sm btn-outline-danger"
                                (click)="confirmRemoveAll()"
                                [disabled]="isRemovingAll() || pairings().length === 0"
                                title="Remove all pairings for this team count">
                            @if (isRemovingAll()) {
                                <span class="spinner-border spinner-border-sm"></span>
                            } @else {
                                <i class="bi bi-trash"></i>
                            }
                            Remove All
                        </button>
                    </div>
                </div>

                <!-- Remove All Confirmation -->
                @if (showRemoveConfirm()) {
                    <div class="alert alert-danger m-2 d-flex align-items-center justify-content-between">
                        <span>
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Delete <strong>all {{ pairings().length }}</strong> pairings for {{ teamCount() }}-team divisions?
                        </span>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-danger" (click)="removeAll()">Yes, Delete All</button>
                            <button class="btn btn-sm btn-outline-secondary" (click)="cancelRemoveAll()">Cancel</button>
                        </div>
                    </div>
                }

                <!-- Loading -->
                @if (isLoading()) {
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                } @else {
                    <div class="grid-body">

                        <!-- Round-Robin Pairings -->
                        @if (roundRobinPairings().length > 0) {
                            <div class="section-label">
                                <i class="bi bi-arrow-repeat me-1"></i> Round-Robin Pairings
                            </div>
                            <div class="table-scroll-wrapper">
                                <table class="table table-sm table-hover pairings-table mb-0">
                                    <thead>
                                        <tr>
                                            <th class="col-gno">G#</th>
                                            <th class="col-rnd">Rnd</th>
                                            <th class="col-team">T1</th>
                                            <th class="col-vs">vs</th>
                                            <th class="col-team">T2</th>
                                            <th class="col-type">Type</th>
                                            <th class="col-status">Status</th>
                                            <th class="col-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (p of roundRobinPairings(); track p.ai) {
                                            <tr [class]="roundClass(p.rnd)"
                                                (dblclick)="startEdit(p.ai)">
                                                <td class="col-gno">{{ p.gameNumber }}</td>
                                                <td class="col-rnd">{{ p.rnd }}</td>
                                                <td class="col-team">{{ p.t1 }}</td>
                                                <td class="col-vs text-secondary">vs</td>
                                                <td class="col-team">{{ p.t2 }}</td>
                                                <td class="col-type">
                                                    <span class="badge bg-secondary-subtle text-secondary-emphasis"
                                                          [title]="typeLabel(p.t1Type) + ' ▸ ' + typeLabel(p.t2Type)">
                                                        {{ typeShort(p.t1Type, p.t2Type) }}
                                                    </span>
                                                </td>
                                                <td class="col-status">
                                                    @if (p.bAvailable) {
                                                        <span class="status-open" title="Not yet scheduled">○</span>
                                                    } @else {
                                                        <span class="status-scheduled" title="Scheduled">●</span>
                                                    }
                                                </td>
                                                <td class="col-actions">
                                                    <button class="btn btn-sm btn-link text-danger p-0"
                                                            (click)="deletePairing(p.ai); $event.stopPropagation()"
                                                            title="Delete pairing">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        <!-- Bracket Pairings -->
                        @if (bracketPairings().length > 0) {
                            <div class="section-label mt-2">
                                <i class="bi bi-trophy me-1"></i> Championship Pairings
                            </div>
                            <div class="table-scroll-wrapper">
                                <table class="table table-sm table-hover pairings-table mb-0">
                                    <thead>
                                        <tr>
                                            <th class="col-gno">G#</th>
                                            <th class="col-rnd">Rnd</th>
                                            <th class="col-team-wide">T1</th>
                                            <th class="col-vs">vs</th>
                                            <th class="col-team-wide">T2</th>
                                            <th class="col-type">Type</th>
                                            <th class="col-status">Status</th>
                                            <th class="col-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (p of bracketPairings(); track p.ai) {
                                            <tr [class]="roundClass(p.rnd)"
                                                (dblclick)="startEdit(p.ai)">
                                                <td class="col-gno">{{ p.gameNumber }}</td>
                                                <td class="col-rnd">{{ p.rnd }}</td>
                                                <td class="col-team-wide">
                                                    @if (p.t1GnoRef) {
                                                        <span class="game-ref" [title]="gameRef(p.t1GnoRef, p.t1CalcType)">
                                                            {{ gameRef(p.t1GnoRef, p.t1CalcType) }}
                                                        </span>
                                                    } @else {
                                                        {{ p.t1 }}
                                                    }
                                                    @if (p.t1Annotation) {
                                                        <span class="annotation">{{ p.t1Annotation }}</span>
                                                    }
                                                </td>
                                                <td class="col-vs text-secondary">vs</td>
                                                <td class="col-team-wide">
                                                    @if (p.t2GnoRef) {
                                                        <span class="game-ref" [title]="gameRef(p.t2GnoRef, p.t2CalcType)">
                                                            {{ gameRef(p.t2GnoRef, p.t2CalcType) }}
                                                        </span>
                                                    } @else {
                                                        {{ p.t2 }}
                                                    }
                                                    @if (p.t2Annotation) {
                                                        <span class="annotation">{{ p.t2Annotation }}</span>
                                                    }
                                                </td>
                                                <td class="col-type">
                                                    <span class="badge"
                                                          [class.bg-warning-subtle]="p.t1Type === 'F'"
                                                          [class.text-warning-emphasis]="p.t1Type === 'F'"
                                                          [class.bg-info-subtle]="p.t1Type === 'S'"
                                                          [class.text-info-emphasis]="p.t1Type === 'S'"
                                                          [class.bg-secondary-subtle]="p.t1Type !== 'F' && p.t1Type !== 'S'"
                                                          [class.text-secondary-emphasis]="p.t1Type !== 'F' && p.t1Type !== 'S'"
                                                          [title]="typeLabel(p.t1Type) + ' ▸ ' + typeLabel(p.t2Type)">
                                                        {{ typeShort(p.t1Type, p.t2Type) }}
                                                    </span>
                                                </td>
                                                <td class="col-status">
                                                    @if (p.bAvailable) {
                                                        <span class="status-open" title="Not yet scheduled">○</span>
                                                    } @else {
                                                        <span class="status-scheduled" title="Scheduled">●</span>
                                                    }
                                                </td>
                                                <td class="col-actions">
                                                    <button class="btn btn-sm btn-link text-danger p-0"
                                                            (click)="deletePairing(p.ai); $event.stopPropagation()"
                                                            title="Delete pairing">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        <!-- Empty state -->
                        @if (pairings().length === 0 && !isLoading()) {
                            <div class="empty-state">
                                <i class="bi bi-calendar-plus text-secondary icon-lg"></i>
                                <p class="text-secondary mt-2 mb-0">No pairings yet. Use <strong>Add Block</strong> or <strong>Championship</strong> to generate.</p>
                            </div>
                        }

                        <!-- ── Division Teams ── -->
                        @if (divisionTeams().length > 0) {
                            <div class="section-label section-label-toggle" (click)="toggleDivisionTeams()">
                                <i class="bi me-1"
                                   [class.bi-chevron-down]="showDivisionTeams()"
                                   [class.bi-chevron-right]="!showDivisionTeams()"></i>
                                Division Teams ({{ divisionTeams().length }})
                            </div>
                            @if (showDivisionTeams()) {
                                <div class="table-scroll-wrapper">
                                    <table class="table table-sm table-hover teams-table mb-0">
                                        <thead>
                                            <tr>
                                                <th class="col-rank">#</th>
                                                <th class="col-club">Club</th>
                                                <th class="col-teamname">Team</th>
                                                <th class="col-actions"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (team of divisionTeams(); track team.teamId) {
                                                <tr (dblclick)="startTeamEdit(team.teamId)">
                                                    @if (editingTeamId() === team.teamId) {
                                                        <td class="col-rank">
                                                            <select class="form-select form-select-sm rank-select"
                                                                    [ngModel]="team.divRank"
                                                                    (ngModelChange)="team.divRank = $event">
                                                                @for (r of rankOptions(); track r) {
                                                                    <option [ngValue]="r">{{ r }}</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td class="col-club text-secondary">{{ team.clubName }}</td>
                                                        <td class="col-teamname">
                                                            <input type="text"
                                                                   class="form-control form-control-sm"
                                                                   [ngModel]="team.teamName"
                                                                   (ngModelChange)="team.teamName = $event">
                                                        </td>
                                                        <td class="col-actions">
                                                            <div class="d-flex gap-1">
                                                                <button class="btn btn-sm btn-link text-success p-0"
                                                                        (click)="saveTeamEdit(team); $event.stopPropagation()"
                                                                        [disabled]="isSavingTeam()"
                                                                        title="Save">
                                                                    @if (isSavingTeam()) {
                                                                        <span class="spinner-border spinner-border-sm"></span>
                                                                    } @else {
                                                                        <i class="bi bi-check-lg"></i>
                                                                    }
                                                                </button>
                                                                <button class="btn btn-sm btn-link text-secondary p-0"
                                                                        (click)="cancelTeamEdit(); $event.stopPropagation()"
                                                                        [disabled]="isSavingTeam()"
                                                                        title="Cancel">
                                                                    <i class="bi bi-x-lg"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    } @else {
                                                        <td class="col-rank fw-semibold">{{ team.divRank }}</td>
                                                        <td class="col-club text-secondary">{{ team.clubName }}</td>
                                                        <td class="col-teamname">{{ team.teamName }}</td>
                                                        <td class="col-actions">
                                                            <button class="btn btn-sm btn-link text-primary p-0"
                                                                    (click)="startTeamEdit(team.teamId); $event.stopPropagation()"
                                                                    title="Edit team">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                        </td>
                                                    }
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        }
                    </div>

                    <!-- ── Who Plays Who Matrix ── -->
                    @if (showWhoPlaysWho() && whoPlaysWhoMatrix()) {
                        <div class="who-plays-who">
                            <div class="section-label">
                                <i class="bi bi-grid-3x3 me-1"></i> Who Plays Who
                            </div>
                            <div class="matrix-scroll">
                                <table class="table table-sm matrix-table mb-0">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            @for (t of teamRange(); track t) {
                                                <th class="text-center">T{{ t }}</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (row of whoPlaysWhoMatrix()!; track $index; let i = $index) {
                                            <tr>
                                                <th>T{{ i + 1 }}</th>
                                                @for (val of row; track $index; let j = $index) {
                                                    <td class="text-center"
                                                        [class.matrix-diagonal]="i === j"
                                                        [class.matrix-zero]="val === 0 && i !== j">
                                                        @if (i === j) { — } @else { {{ val }} }
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </div>
</div>

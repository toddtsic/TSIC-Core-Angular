<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between mb-4 gap-2">
                <div>
                    <h2 class="d-inline-block mb-0 text-nowrap"><i class="bi bi-database-gear me-2"></i> Player Profile
                        Migration</h2>
                </div>
                <div class="w-100 w-md-auto d-flex justify-content-center justify-content-md-end">
                    <div class="btn-group btn-group-sm">
                        <a [routerLink]="['/', jobPath(), 'home']" mat-stroked-button>
                            <i class="bi bi-house-door me-1"></i> <span class="d-none d-sm-inline">Home</span><span
                                class="d-inline d-sm-none">Home</span>
                        </a>
                        <button mat-stroked-button (click)="loadProfiles()" [disabled]="isLoading()">
                            <i class="bi bi-arrow-clockwise me-1"></i> <span
                                class="d-none d-sm-inline">Refresh</span><span class="d-inline d-sm-none">Ref</span>
                        </button>
                        <a [routerLink]="['/', jobPath(), 'admin', 'profile-editor']" mat-raised-button color="primary">
                            <i class="bi bi-pencil-square me-1"></i> <span class="d-none d-sm-inline">Profile
                                Editor</span><span class="d-inline d-sm-none">Editor</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Alert Messages -->
            @if (errorMessage()) {
            <mat-card appearance="outlined" class="mb-3" role="alert" aria-live="polite">
                <div class="d-flex align-items-start justify-content-between gap-2">
                    <div><i class="bi bi-exclamation-triangle-fill"></i> {{ errorMessage() }}</div>
                    <button mat-stroked-button type="button" (click)="clearMessages()">Dismiss</button>
                </div>
            </mat-card>
            }

            @if (successMessage()) {
            <mat-card appearance="outlined" class="mb-3" aria-live="polite">
                <div class="d-flex align-items-start justify-content-between gap-2">
                    <div><i class="bi bi-check-circle-fill"></i> {{ successMessage() }}</div>
                    <button mat-stroked-button type="button" (click)="clearMessages()">Dismiss</button>
                </div>
            </mat-card>
            }

            <!-- Info Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-info-circle"></i> About Migration</h5>
                    <p class="card-text">
                        This tool converts player profile class definitions from GitHub (POCO files) into JSON metadata
                        stored in the database.
                        Each profile type (PP10, PP17, CAC05, etc.) is migrated once and applied to all jobs using that
                        profile.
                    </p>
                    <mat-card appearance="outlined" class="mb-0">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Note:</strong> Migration fetches from GitHub and may take a few moments. After
                        migration, use the Profile Editor to make changes.
                    </mat-card>
                </div>
            </div>

            <!-- Migration Actions -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Quick Actions</h5>
                            <small class="text-muted">
                                {{ pendingProfiles.length }} pending profiles affecting {{ totalJobs - migratedJobs }}
                                jobs
                            </small>
                        </div>
                        <div class="btn-group">
                            <button mat-raised-button color="accent" (click)="migrateAllPending()"
                                [disabled]="isLoading() || isMigrating() || pendingProfiles.length === 0">
                                @if (isMigrating()) {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Migrating...
                                } @else {
                                <i class="bi bi-play-fill"></i> Migrate All Pending
                                }
                            </button>
                            <button mat-stroked-button color="warn" (click)="reMigrateAll()"
                                [disabled]="isLoading() || isMigrating() || profiles().length === 0"
                                title="Force re-migration of all profiles, even if already migrated">
                                <i class="bi bi-arrow-repeat"></i> Re-Migrate All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            @if (profiles().length > 0) {
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart"></i> Summary</h5>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3>{{ profiles().length }}</h3>
                            <small class="text-muted">Total Profiles</small>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-success">{{ migratedProfiles.length }}</h3>
                            <small class="text-muted">Migrated</small>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-warning">{{ pendingProfiles.length }}</h3>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="col-md-3">
                            <h3>{{ totalJobs }}</h3>
                            <small class="text-muted">Total Jobs (All Years)</small>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Profile List -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Profile Types</h5>
                    <div class="ms-auto" style="min-width:220px;">
                        <select class="form-select form-select-sm" style="width:auto; float:right;"
                            title="Select Profile Type" (change)="onProfileTypeChange($event)">
                            <option value="">-- All Profiles --</option>
                            @for (profile of profiles(); track profile.profileType) {
                            <option [value]="profile.profileType"
                                [selected]="selectedProfileType() === profile.profileType">
                                {{ profile.profileType }}
                            </option>
                            }
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    @if (isLoading()) {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary">
                            <output class="visually-hidden">Loading...</output>
                        </div>
                        <p class="mt-3">Loading profiles...</p>
                    </div>
                    } @else if (profiles().length === 0) {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">No profiles found in database</p>
                    </div>
                    } @else {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Profile Type</th>
                                    <th>Jobs Using</th>
                                    <th>Migration Status</th>
                                    <th>Sample Jobs</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (profile of filteredProfiles(); track profile.profileType) {
                                <tr>
                                    <td>
                                        <strong>{{ profile.profileType }}</strong>
                                    </td>
                                    <td>
                                        <mat-chip-set>
                                            <mat-chip>{{ profile.jobCount }} jobs</mat-chip>
                                        </mat-chip-set>
                                    </td>
                                    <td>
                                        @if (profile.allJobsMigrated) {
                                        <mat-chip-set>
                                            <mat-chip><i class="bi bi-check-circle"></i> Migrated</mat-chip>
                                        </mat-chip-set>
                                        <small class="text-muted d-block">
                                            {{ profile.migratedJobCount }}/{{ profile.jobCount }} jobs
                                        </small>
                                        } @else {
                                        <mat-chip-set>
                                            <mat-chip><i class="bi bi-clock"></i> Pending</mat-chip>
                                        </mat-chip-set>
                                        <small class="text-muted d-block">
                                            {{ profile.migratedJobCount }}/{{ profile.jobCount }} jobs
                                        </small>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ profile.sampleJobNames.slice(0, 3).join(', ') }}
                                            @if (profile.sampleJobNames.length > 3) {
                                            <span>...</span>
                                            }
                                        </small>
                                    </td>
                                    <td>
                                        <fieldset class="btn-group btn-group-sm">
                                            <button mat-stroked-button (click)="previewSingle(profile)"
                                                [disabled]="isMigrating() || !profile.allJobsMigrated"
                                                [title]="profile.allJobsMigrated ? 'View current metadata' : 'Migrate first to preview'">
                                                <i class="bi bi-eye"></i> Preview
                                            </button>
                                            <button mat-raised-button color="accent" (click)="migrateSingle(profile)"
                                                [disabled]="isMigrating()">
                                                <i class="bi bi-arrow-repeat"></i>
                                                {{ profile.allJobsMigrated ? 'Re-migrate' : 'Migrate' }}
                                            </button>
                                        </fieldset>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Dialog -->
@if (showConfirmModal()) {
<tsic-dialog [open]="true" [closeOnBackdrop]="true" (requestClose)="closeConfirmModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="bi bi-exclamation-triangle text-warning"></i> {{ confirmModalTitle() }}
            </h5>
            <button type="button" class="btn-close" (click)="closeConfirmModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <p>{{ confirmModalMessage() }}</p>
        </div>
        <div class="modal-footer">
            <button type="button" mat-stroked-button (click)="closeConfirmModal()" autofocus>Cancel</button>
            <button type="button" mat-raised-button color="primary" (click)="confirmAction()">
                <i class="bi bi-check-circle"></i> OK
            </button>
        </div>
    </div>
</tsic-dialog>
}

<!-- Preview Dialog -->
@if (previewResult()) {
<tsic-dialog [open]="true" size="lg" [closeOnBackdrop]="true" (requestClose)="closePreview()">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="bi bi-eye"></i>
                @if (selectedProfile()?.allJobsMigrated) {
                Current Metadata: {{ selectedProfile()?.profileType }}
                } @else {
                Preview Migration: {{ selectedProfile()?.profileType }}
                }
            </h5>
            <button type="button" class="btn-close" (click)="closePreview()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            @if (previewResult()?.success) {
            <mat-card appearance="outlined">
                <i class="bi bi-info-circle"></i>
                @if (selectedProfile()?.allJobsMigrated) {
                Currently applied to <strong>{{ previewResult()?.jobsAffected }}</strong> job{{
                previewResult()!.jobsAffected > 1 ? 's' : '' }}
                with <strong>{{ previewResult()?.fieldCount }}</strong> field{{ previewResult()!.fieldCount > 1 ?
                's' : '' }}.
                } @else {
                This migration will affect <strong>{{ previewResult()?.jobsAffected }}</strong> job{{
                previewResult()!.jobsAffected > 1 ? 's' : '' }}
                with <strong>{{ previewResult()?.fieldCount }}</strong> field{{ previewResult()!.fieldCount > 1 ?
                's' : '' }}.
                }
            </mat-card>

            <!-- Form Preview -->
            @if (previewResult()?.generatedMetadata) {
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-ui-checks"></i> Form Preview
                    </h6>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" (click)="toggleJsonView()">
                            @if (showJsonView()) {
                            <i class="bi bi-ui-checks"></i> Show Form
                            } @else {
                            <i class="bi bi-code-square"></i> Show JSON
                            }
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Job Selector for Dynamic Preview -->
                    <div class="mb-3 border-bottom pb-3">
                        <label for="jobSelectorDropdown" class="form-label">
                            <strong>Preview with Job-Specific Options (Current Year ± 1):</strong>
                        </label>
                        <select id="jobSelectorDropdown" class="form-select" (change)="onJobSelected($event)">
                            <option value="">Select a job to see its specific dropdown options...</option>
                            @for (job of sortedAffectedJobs(); track job.name) {
                            <option>{{ job.name }}</option>
                            }
                        </select>
                        @if (selectedJobId()) {
                        <mat-card appearance="outlined" class="py-2 px-3 mb-0 mt-2" aria-live="polite">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle" aria-hidden="true"></i>
                                <output class="small">Showing dropdown options for selected job</output>
                            </div>
                        </mat-card>
                        } @else {
                        <small class="text-muted d-block mt-1">
                            Select a job to preview with that job's specific dropdown values (from JsonOptions).
                        </small>
                        }
                    </div>

                    @if (showJsonView()) {
                    <!-- JSON View -->
                    <pre class="bg-light p-3 rounded"
                        style="max-height: 500px; overflow-y: auto;"><code>{{ previewResult()!.generatedMetadata | json }}</code></pre>
                    } @else {
                    <!-- Form Preview -->
                    <app-profile-form-preview [metadata]="previewResult()?.generatedMetadata ?? null"
                        [jobOptions]="jobSpecificOptions()" [showFieldNumbers]="true" [showValidationHints]="true">
                    </app-profile-form-preview>
                    }
                </div>
            </div>
            }

            <div class="mb-3">
                <label for="affectedJobsDropdown" class="form-label">
                    <strong>All Affected Jobs: {{ sortedAffectedJobs().length }} (Current Year ± 1)</strong>
                </label>
                <select id="affectedJobsDropdown" class="form-select">
                    @for (job of sortedAffectedJobs(); track job.name) {
                    <option>{{ job.name }}</option>
                    }
                </select>
                @if (sortedAffectedJobs().length === 0) {
                <small class="text-muted">No jobs from current year ± 1 use this profile type.</small>
                }
            </div>

            @if (previewResult()?.warnings && previewResult()!.warnings.length > 0) {
            <mat-card appearance="outlined">
                <h6><i class="bi bi-exclamation-triangle"></i> Warnings:</h6>
                <ul class="mb-0">
                    @for (warning of previewResult()?.warnings; track warning) {
                    <li>{{ warning }}</li>
                    }
                </ul>
            </mat-card>
            }
            } @else {
            <mat-card appearance="outlined">
                <i class="bi bi-x-circle"></i> {{ previewResult()?.errorMessage }}
            </mat-card>
            }
        </div>
        <div class="modal-footer">
            <button type="button" mat-stroked-button (click)="closePreview()" autofocus>Close</button>
            @if (previewResult()?.success && selectedProfile() && !selectedProfile()?.allJobsMigrated) {
            <button type="button" mat-raised-button color="accent"
                (click)="migrateSingle(selectedProfile()!); closePreview()">
                <i class="bi bi-check-circle"></i> Migrate Now
            </button>
            }
        </div>
    </div>
</tsic-dialog>
}